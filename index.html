<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPMS - Spare Part Management System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scan-line { 0% { top: 0%; } 100% { top: 100%; } }
        .animate-scan-line { position: absolute; animation: scan-line 2s linear infinite; }
        
        /* Custom Scrollbar for side panels */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
    </style>

    <!-- React, ReactDOM, dan Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- FIX: Pustaka lucide-react versi UMD -->
    <script>
        window.react = window.React;
        window._moduleBackup = window.module;
        window._exportsBackup = window.exports;
        window.module = undefined;
        window.exports = undefined;
    </script>
    
    <!-- Lucide React Icons UMD -->
    <script crossorigin src="https://unpkg.com/lucide-react@0.344.0/dist/umd/lucide-react.js"></script>

    <script>
        window.module = window._moduleBackup;
        window.exports = window._exportsBackup;
    </script>
    
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Library SheetJS untuk baca/tulis Excel & impor CSV -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- Pustaka Three.js untuk Simulasi Gudang 3D -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body class="text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-950 overflow-x-hidden">
    
    <!-- Root container untuk React -->
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;
        
        // Fallback icon - Menggunakan SVG sederhana agar terhindar dari masalah object
        const FallbackIcon = (props) => {
          const size = (props && props.size) ? props.size : 24;
          const className = (props && props.className) ? props.className : "";
          return (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
          );
        };

        // Ambil icon dari window.lucideReact, atau gunakan FallbackIcon jika tidak ada
        const lucide = window.lucideReact || {};
        const getIcon = (iconName) => { return (lucide && lucide[iconName]) ? lucide[iconName] : FallbackIcon; };

        const LayoutDashboard = getIcon('LayoutDashboard');
        const Package = getIcon('Package');
        const Truck = getIcon('Truck');
        const Users = getIcon('Users');
        const ArrowDownToLine = getIcon('ArrowDownToLine');
        const ArrowUpFromLine = getIcon('ArrowUpFromLine');
        const RefreshCw = getIcon('RefreshCw');
        const ClipboardCheck = getIcon('ClipboardCheck');
        const ArrowRightLeft = getIcon('ArrowRightLeft');
        const FileBarChart = getIcon('FileBarChart');
        const Settings = getIcon('Settings');
        const Bell = getIcon('Bell');
        const Moon = getIcon('Moon');
        const Sun = getIcon('Sun');
        const Search = getIcon('Search');
        const Plus = getIcon('Plus');
        const Filter = getIcon('Filter');
        const X = getIcon('X');
        const Menu = getIcon('Menu');
        const AlertTriangle = getIcon('AlertTriangle');
        const CheckCircle2 = getIcon('CheckCircle2');
        const Edit = getIcon('Edit');
        const Trash2 = getIcon('Trash2');
        const QrCode = getIcon('QrCode');
        const ShoppingCart = getIcon('ShoppingCart');
        const FileText = getIcon('FileText');
        const Calendar = getIcon('Calendar');
        const Clock = getIcon('Clock');
        const ChevronDown = getIcon('ChevronDown');
        const ChevronRight = getIcon('ChevronRight');
        const ImageIcon = getIcon('Image');
        const Save = getIcon('Save');
        const Eye = getIcon('Eye');
        const EyeOff = getIcon('EyeOff');
        const TrendingUp = getIcon('TrendingUp');
        const TrendingDown = getIcon('TrendingDown');
        const Activity = getIcon('Activity');
        const BarChart2 = getIcon('BarChart2');
        const ArrowRight = getIcon('ArrowRight');
        const AlertCircle = getIcon('AlertCircle');
        const Upload = getIcon('Upload');
        const LinkIcon = getIcon('Link');
        const MapIcon = getIcon('Map'); 
        const PlusCircle = getIcon('PlusCircle');
        const BoxIcon = getIcon('Box');
        const Info = getIcon('Info');

        // --- MOCK DATA: 3D WAREHOUSE INITIALIZATION ---
        // Membuat layout: Rak 1-10 secara vertikal, 1 rak horizontal besar di bawah.
        const generateInitialWarehouse = () => {
            const layout = [];
            // Rack 1 to 10 (Vertical Racks)
            for(let i=1; i<=10; i++) {
                layout.push({
                    id: `R${i}`, name: `Rack ${i}`,
                    stages: Array.from({length: 3}, (_, sIdx) => ({
                        id: `S${i}-${sIdx+1}`, name: `Level ${sIdx+1}`,
                        bins: Array.from({length: 5}, (_, bIdx) => ({
                            id: `B${i}-${sIdx+1}-${bIdx+1}`, name: `R${i}-${sIdx+1}-${bIdx+1}`
                        }))
                    }))
                });
            }
            // Bottom Horizontal Rack diganti menjadi Area Pallet
            layout.push({
                id: `RB`, name: `Area Pallet (Lantai)`,
                stages: Array.from({length: 3}, (_, sIdx) => ({
                    id: `SB-${sIdx+1}`, name: `Tumpukan ${sIdx+1}`,
                    bins: Array.from({length: 15}, (_, bIdx) => ({
                        id: `BB-${sIdx+1}-${bIdx+1}`, name: `PALLET-${sIdx+1}-${bIdx+1}`
                    }))
                }))
            });
            return layout;
        };

        const initialWarehouse = generateInitialWarehouse();

        const initialItems = [
          { id: 'ITM-0001', name: 'Bearing SKF 6204', category: 'Mechanical', partNo: 'SKF-6204-ZZ', unit: 'PCS', stock: 15, minStock: 20, maxStock: 100, price: 150000, location: 'R1-1-1', status: 'Active', specs: 'Inner Diameter: 20mm' },
          { id: 'ITM-0002', name: 'Contactor Schneider LC1D09', category: 'Electrical', partNo: 'LC1D09M7', unit: 'PCS', stock: 45, minStock: 10, maxStock: 50, price: 350000, location: 'R2-2-3', status: 'Active', specs: 'Poles: 3, 220VAC' },
          { id: 'ITM-0003', name: 'Hydraulic Oil Shell Tellus', category: 'Chemical', partNo: 'TELLUS-S2-M46', unit: 'Drum', stock: 2, minStock: 5, maxStock: 20, price: 4500000, location: 'PALLET-1-5', status: 'Active', specs: 'Volume: 209L' },
          { id: 'ITM-0004', name: 'V-Belt B-42', category: 'Mechanical', partNo: 'B-42-MITSUBOSHI', unit: 'PCS', stock: 120, minStock: 50, maxStock: 200, price: 85000, location: 'R4-3-1', status: 'Active', specs: 'Length: 42 inch' },
          { id: 'ITM-0005', name: 'Sensor Proximity M12', category: 'Electrical', partNo: 'PR12-4DN', unit: 'PCS', stock: 8, minStock: 15, maxStock: 30, price: 210000, location: 'R10-2-4', status: 'Active', specs: 'NPN NO, 12-24VDC' },
        ];

        const initialTransactions = [
          { id: 'TRX-1001', date: '20/02/2026 08:30:15', type: 'IN', itemId: 'ITM-0001', qty: 50, user: 'Admin User', ref: 'PO-2026-001', dept: 'PT Surya Teknik' },
          { id: 'TRX-1002', date: '20/02/2026 10:15:42', type: 'OUT', itemId: 'ITM-0002', qty: 5, user: 'Warehouse Staff', ref: 'Budi Santoso', dept: 'Production' },
        ];

        const initialSuppliers = [
          { id: 'SUP-001', name: 'PT Surya Teknik', contact: '08123456789', email: 'sales@suryateknik.com', status: 'Active' },
          { id: 'SUP-002', name: 'CV Makmur Jaya', contact: '08567890123', email: 'info@makmurjaya.co.id', status: 'Active' },
        ];

        const initialUsers = [
          { id: 'USR-001', name: 'Budi Santoso', role: 'Admin', dept: 'IT', status: 'Active' },
          { id: 'USR-002', name: 'Andi Wijaya', role: 'Warehouse Staff', dept: 'Logistics', status: 'Active' },
        ];

        // --- BUTTON COMPONENT ---
        const Button = ({ children, onClick, variant = 'primary', className = '', icon: Icon, type = 'button', disabled = false }) => {
          const baseStyle = "flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-medium transition-colors text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap";
          const variants = {
            primary: "bg-blue-600 hover:bg-blue-700 text-white focus:ring-blue-500 shadow-sm",
            secondary: "bg-gray-100 hover:bg-gray-200 text-gray-700 dark:bg-gray-800 dark:hover:bg-gray-700 dark:text-gray-200 focus:ring-gray-500",
            danger: "bg-red-600 hover:bg-red-700 text-white focus:ring-red-500",
            outline: "border border-gray-300 hover:bg-gray-50 text-gray-700 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-800",
          };
          return (
            <button type={type} onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
              {Icon && <Icon size={16} />}
              {children}
            </button>
          );
        };

        // --- VIEW: DASHBOARD ---
        const DashboardView = ({ items, transactions, setCurrentView }) => {
          const currentYear = new Date().getFullYear();
          const parseDate = (dStr) => { const [datePart] = dStr.split(' '); const [d, m, y] = datePart.split('/'); return new Date(y, m - 1, d); };

          let ytdIn = 0; let ytdOut = 0;
          const itemStats = items.reduce((acc, item) => ({ ...acc, [item.id]: { ...item, inQty: 0, outQty: 0 } }), {});

          const last7Days = Array.from({ length: 7 }, (_, i) => {
            const d = new Date(); d.setDate(d.getDate() - (6 - i));
            return { dateStr: d.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit' }), in: 0, out: 0, dObj: d };
          });
          const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'].map(m => ({ month: m, in: 0, out: 0 }));

          transactions.forEach(t => {
            const d = parseDate(t.date);
            const qty = Number(t.qty);
            if (d.getFullYear() === currentYear) {
              if (t.type === 'IN') ytdIn += qty;
              if (t.type === 'OUT') ytdOut += qty;
              months[d.getMonth()][t.type === 'IN' ? 'in' : 'out'] += qty;
            }
            const dayMatch = last7Days.find(day => day.dObj.getDate() === d.getDate() && day.dObj.getMonth() === d.getMonth() && day.dObj.getFullYear() === d.getFullYear());
            if (dayMatch) {
              if (t.type === 'IN') dayMatch.in += qty;
              if (t.type === 'OUT') dayMatch.out += qty;
            }
            if (itemStats[t.itemId]) {
              if (t.type === 'IN') itemStats[t.itemId].inQty += qty;
              if (t.type === 'OUT') itemStats[t.itemId].outQty += qty;
            }
          });

          const maxDaily = Math.max(...last7Days.flatMap(d => [d.in, d.out]), 10);
          const maxMonthly = Math.max(...months.flatMap(m => [m.in, m.out]), 10);
          const sortedByOut = Object.values(itemStats).sort((a, b) => b.outQty - a.outQty);
          const fastMoving = sortedByOut.slice(0, 5);
          const slowMoving = [...sortedByOut].reverse().slice(0, 5);
          const totalValue = items.reduce((a, b) => a + (b.stock * b.price), 0);

          return (
            <div className="space-y-6 animate-in fade-in duration-500 font-sans">
              <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between border-b dark:border-gray-800 pb-4 gap-4">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900 dark:text-white tracking-tight uppercase">Executive Dashboard</h2>
                  <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">Ringkasan inventaris dan analitik pergerakan barang</p>
                </div>
                <div className="text-xs text-blue-600 bg-blue-50 dark:bg-blue-900/30 px-3 py-1.5 rounded-lg font-bold uppercase tracking-widest flex items-center gap-2 border border-blue-100 dark:border-blue-800/50">
                  <Calendar size={14} />
                  {new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                </div>
              </div>
              
              <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                <div className="bg-white dark:bg-gray-900 p-5 rounded-2xl border dark:border-gray-800 shadow-sm flex flex-col gap-2 transition-all hover:shadow-md">
                  <div className="flex items-center gap-3"><div className="p-2 bg-blue-50 dark:bg-blue-900/30 text-blue-600 rounded-lg"><Package size={20}/></div><p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Total Material</p></div>
                  <p className="text-2xl sm:text-3xl font-bold dark:text-white mt-1">{items.length} <span className="text-xs text-gray-400 font-medium tracking-normal">SKU</span></p>
                </div>
                <div className="bg-white dark:bg-gray-900 p-5 rounded-2xl border dark:border-gray-800 shadow-sm flex flex-col gap-2 transition-all hover:shadow-md">
                  <div className="flex items-center gap-3"><div className="p-2 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 rounded-lg"><FileBarChart size={20}/></div><p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Total Value (Rp)</p></div>
                  <p className="text-xl sm:text-2xl font-bold dark:text-white mt-1 whitespace-nowrap overflow-hidden text-ellipsis" title={totalValue.toLocaleString('id-ID')}>{totalValue.toLocaleString('id-ID')}</p>
                </div>
                <div className="bg-white dark:bg-gray-900 p-5 rounded-2xl border dark:border-gray-800 shadow-sm flex flex-col gap-2 transition-all hover:shadow-md">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3"><div className="p-2 bg-green-50 dark:bg-green-900/30 text-green-600 rounded-lg"><ArrowDownToLine size={20}/></div><p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">YTD Masuk</p></div>
                    <span className="text-[10px] bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded font-bold text-gray-500">{currentYear}</span>
                  </div>
                  <p className="text-2xl sm:text-3xl font-bold text-green-600 mt-1">+{ytdIn}</p>
                </div>
                <div className="bg-white dark:bg-gray-900 p-5 rounded-2xl border dark:border-gray-800 shadow-sm flex flex-col gap-2 transition-all hover:shadow-md">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3"><div className="p-2 bg-orange-50 dark:bg-orange-900/30 text-orange-600 rounded-lg"><ArrowUpFromLine size={20}/></div><p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">YTD Keluar</p></div>
                    <span className="text-[10px] bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded font-bold text-gray-500">{currentYear}</span>
                  </div>
                  <p className="text-2xl sm:text-3xl font-bold text-orange-600 mt-1">-{ytdOut}</p>
                </div>
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="bg-white dark:bg-gray-900 rounded-2xl border dark:border-gray-800 shadow-sm p-5 flex flex-col">
                  <div className="flex justify-between items-center mb-6">
                    <h3 className="text-sm font-bold dark:text-white uppercase tracking-wider flex items-center gap-2"><Activity size={16} className="text-blue-500"/> Tren Harian (7 Hari Terakhir)</h3>
                    <div className="flex gap-3 text-[10px] font-bold uppercase tracking-wider text-gray-400">
                      <div className="flex items-center gap-1"><div className="w-2 h-2 bg-green-500 rounded-full"></div>Masuk</div>
                      <div className="flex items-center gap-1"><div className="w-2 h-2 bg-orange-500 rounded-full"></div>Keluar</div>
                    </div>
                  </div>
                  <div className="h-48 flex items-end gap-2 sm:gap-4 mt-auto border-b dark:border-gray-800 pb-2">
                    {last7Days.map((day, idx) => (
                      <div key={idx} className="flex-1 flex flex-col items-center gap-2 group relative">
                        <div className="absolute -top-10 bg-gray-900 text-white text-[10px] font-bold px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10 pointer-events-none">
                          In: {day.in} | Out: {day.out}
                        </div>
                        <div className="w-full h-full flex items-end justify-center gap-0.5 sm:gap-1">
                          <div className="w-full max-w-[20px] bg-green-500 rounded-t-sm transition-all duration-500 hover:brightness-110" style={{ height: `${(day.in / maxDaily) * 100}%`, minHeight: day.in > 0 ? '4px' : '0' }}></div>
                          <div className="w-full max-w-[20px] bg-orange-500 rounded-t-sm transition-all duration-500 hover:brightness-110" style={{ height: `${(day.out / maxDaily) * 100}%`, minHeight: day.out > 0 ? '4px' : '0' }}></div>
                        </div>
                        <span className="text-[9px] sm:text-[10px] font-medium text-gray-400">{day.dateStr}</span>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="bg-white dark:bg-gray-900 rounded-2xl border dark:border-gray-800 shadow-sm p-5 flex flex-col">
                  <div className="flex justify-between items-center mb-6">
                    <h3 className="text-sm font-bold dark:text-white uppercase tracking-wider flex items-center gap-2"><BarChart2 size={16} className="text-purple-500"/> Tren Bulanan (YTD {currentYear})</h3>
                  </div>
                  <div className="h-48 flex items-end gap-1 sm:gap-2 mt-auto border-b dark:border-gray-800 pb-2">
                    {months.map((m, idx) => (
                      <div key={idx} className="flex-1 flex flex-col items-center gap-2 group relative">
                        <div className="absolute -top-10 bg-gray-900 text-white text-[10px] font-bold px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10 pointer-events-none">
                          In: {m.in} | Out: {m.out}
                        </div>
                        <div className="w-full h-full flex items-end justify-center gap-0.5">
                          <div className="w-full max-w-[12px] bg-green-400/80 rounded-t-sm transition-all duration-500" style={{ height: `${(m.in / maxMonthly) * 100}%`, minHeight: m.in > 0 ? '4px' : '0' }}></div>
                          <div className="w-full max-w-[12px] bg-orange-400/80 rounded-t-sm transition-all duration-500" style={{ height: `${(m.out / maxMonthly) * 100}%`, minHeight: m.out > 0 ? '4px' : '0' }}></div>
                        </div>
                        <span className="text-[9px] font-medium text-gray-400">{m.month}</span>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="bg-white dark:bg-gray-900 rounded-2xl border dark:border-gray-800 shadow-sm overflow-hidden">
                  <div className="p-4 border-b dark:border-gray-800 flex justify-between items-center bg-gray-50/50 dark:bg-gray-900/50">
                    <h3 className="text-xs font-bold uppercase tracking-wider text-gray-700 dark:text-gray-300 flex items-center gap-2"><TrendingUp size={16} className="text-green-500"/> Fast Moving Items</h3>
                    <span className="text-[10px] bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 px-2 py-1 rounded font-bold uppercase tracking-widest">Top 5 Keluar</span>
                  </div>
                  <div className="divide-y dark:divide-gray-800">
                    {fastMoving.map((item, idx) => (
                      <div key={item.id} className="p-4 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                        <div className="flex items-center gap-3">
                          <div className="text-gray-400 font-bold text-xs w-4">{idx + 1}.</div>
                          <div>
                            <p className="font-bold text-sm text-gray-900 dark:text-white">{item.name}</p>
                            <p className="text-[10px] text-gray-500 font-mono mt-0.5">{item.id}</p>
                          </div>
                        </div>
                        <div className="text-right">
                          <p className="text-lg font-bold text-green-600">{item.outQty} <span className="text-[10px] text-gray-400 uppercase">{item.unit}</span></p>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="bg-white dark:bg-gray-900 rounded-2xl border dark:border-gray-800 shadow-sm overflow-hidden">
                  <div className="p-4 border-b dark:border-gray-800 flex justify-between items-center bg-gray-50/50 dark:bg-gray-900/50">
                    <h3 className="text-xs font-bold uppercase tracking-wider text-gray-700 dark:text-gray-300 flex items-center gap-2"><TrendingDown size={16} className="text-red-500"/> Slow Moving Items</h3>
                    <span className="text-[10px] bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400 px-2 py-1 rounded font-bold uppercase tracking-widest">Paling Pasif</span>
                  </div>
                  <div className="divide-y dark:divide-gray-800">
                    {slowMoving.map((item, idx) => (
                      <div key={item.id} className="p-4 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                        <div className="flex items-center gap-3">
                          <div className="text-gray-400 font-bold text-xs w-4">{idx + 1}.</div>
                          <div>
                            <p className="font-bold text-sm text-gray-900 dark:text-white">{item.name}</p>
                            <p className="text-[10px] text-gray-500 font-mono mt-0.5">{item.id}</p>
                          </div>
                        </div>
                        <div className="text-right">
                          <p className="text-lg font-bold text-red-500">{item.outQty} <span className="text-[10px] text-gray-400 uppercase">{item.unit}</span></p>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              <div className="bg-white dark:bg-gray-900 rounded-xl border dark:border-gray-800 shadow-sm overflow-hidden">
                 <div className="px-6 py-4 border-b dark:border-gray-800 flex justify-between items-center bg-gray-50/30">
                    <h3 className="text-xs font-bold uppercase tracking-wider text-gray-500">Aktivitas Terakhir</h3>
                    <button onClick={() => setCurrentView('transaction-log')} className="text-xs font-bold text-blue-600 hover:text-blue-700 flex items-center gap-1 transition-colors">Log Lengkap <ArrowRight size={14}/></button>
                 </div>
                 <div className="divide-y dark:divide-gray-800">
                    {transactions.slice(0, 4).map(t => {
                       const trItem = items.find(i => i.id === t.itemId);
                       return (
                          <div key={t.id} className="px-6 py-4 flex items-center justify-between hover:bg-gray-50/50 dark:hover:bg-gray-800/30 transition-all">
                             <div className="flex items-center gap-4">
                                <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${t.type === 'IN' ? 'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400' : 'bg-orange-100 text-orange-600 dark:bg-orange-900/30 dark:text-orange-400'}`}>
                                   {t.type === 'IN' ? <ArrowDownToLine size={20}/> : <ArrowUpFromLine size={20}/>}
                                </div>
                                <div>
                                   <p className="font-bold text-gray-900 dark:text-white text-sm">{trItem?.name || 'Unknown Item'}</p>
                                   <p className="text-[10px] text-gray-400 font-bold uppercase mt-0.5 tracking-tighter">{t.id} â€¢ {t.date}</p>
                                </div>
                             </div>
                             <div className={`text-lg font-bold ${t.type === 'IN' ? 'text-green-600' : 'text-orange-600'}`}>
                                {t.type === 'IN' ? '+' : '-'}{t.qty} <span className="text-[10px] uppercase text-gray-400 ml-1">{trItem?.unit || 'PCS'}</span>
                             </div>
                          </div>
                       )
                    })}
                 </div>
              </div>
            </div>
          );
        };

        // --- VIEW: VIRTUAL WAREHOUSE 3D ---
        const VirtualWarehouseView = ({ items, warehouseLayout, setWarehouseLayout, showNotification }) => {
          const mountRef = useRef(null);
          const tooltipRef = useRef(null); 
          const [searchQuery, setSearchQuery] = useState('');
          const sceneRef = useRef(null);
          const binsRef = useRef({}); 
          const [is3DReady, setIs3DReady] = useState(false);

          // 1. Inisialisasi Three.js Canvas & ResizeObserver
          useEffect(() => {
            if (!mountRef.current || !window.THREE) return;
            
            mountRef.current.innerHTML = ''; 

            const initWidth = mountRef.current.clientWidth || 800;
            const initHeight = mountRef.current.clientHeight || 400;

            const scene = new window.THREE.Scene();
            scene.background = new window.THREE.Color(0xf1f5f9); 
            scene.fog = new window.THREE.Fog(0xf1f5f9, 30, 150);
            sceneRef.current = scene;

            const camera = new window.THREE.PerspectiveCamera(45, initWidth / initHeight, 0.1, 1000);
            camera.position.set(0, 60, 60);

            const renderer = new window.THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(initWidth, initHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = window.THREE.PCFSoftShadowMap;
            mountRef.current.appendChild(renderer.domElement);

            const controls = new window.THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.maxPolarAngle = Math.PI / 2 - 0.05; 
            controls.target.set(0, 0, 5);

            const ambientLight = new window.THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const dirLight = new window.THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(20, 60, 20);
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 2048;
            dirLight.shadow.mapSize.height = 2048;
            scene.add(dirLight);

            const floorGeo = new window.THREE.PlaneGeometry(200, 200);
            const floorMat = new window.THREE.MeshStandardMaterial({ color: 0x94a3b8, roughness: 0.8 });
            const floor = new window.THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            const gridHelper = new window.THREE.GridHelper(100, 50, 0x000000, 0x000000);
            gridHelper.material.opacity = 0.1;
            gridHelper.material.transparent = true;
            scene.add(gridHelper);

            // --- FUNGSI RAYCASTER (Hover Tooltip 3D) ---
            const raycaster = new window.THREE.Raycaster();
            const mouse = new window.THREE.Vector2();

            const handleMouseMove = (event) => {
                if (!mountRef.current || !tooltipRef.current) return;
                const rect = mountRef.current.getBoundingClientRect();
                mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(scene.children, true);
                
                const binHit = intersects.find(hit => hit.object.userData && hit.object.userData.binId);

                if (binHit) {
                    const data = binHit.object.userData;
                    tooltipRef.current.style.display = 'block';
                    tooltipRef.current.style.left = (event.clientX - rect.left + 15) + 'px';
                    tooltipRef.current.style.top = (event.clientY - rect.top + 15) + 'px';
                    
                    let content = `<div style="font-weight:bold; border-bottom:1px solid #374151; padding-bottom:4px; margin-bottom:4px; font-size:12px;">Lokasi BIN: ${data.binId}</div>`;
                    if (data.itemsInside && data.itemsInside.length > 0) {
                        data.itemsInside.forEach(itm => {
                            content += `<div style="margin-top:6px; line-height: 1.3; font-size:11px;">
                                          <span style="font-weight:bold;">${itm.name}</span> <br/> 
                                          <span style="color:#93c5fd; font-family:monospace;">${itm.id}</span> <br/>
                                          Stok: <span style="color:#4ade80; font-weight:bold; font-size:12px;">${itm.stock} ${itm.unit}</span>
                                        </div>`;
                        });
                    } else {
                        content += `<div style="color:#9ca3af; font-style:italic; font-size:11px;">(Kosong / Tidak ada barang)</div>`;
                    }
                    tooltipRef.current.innerHTML = content;
                    mountRef.current.style.cursor = 'pointer'; 
                } else {
                    tooltipRef.current.style.display = 'none';
                    mountRef.current.style.cursor = 'grab'; 
                }
            };

            mountRef.current.addEventListener('mousemove', handleMouseMove);

            let animationFrameId;
            const animate = () => {
                animationFrameId = requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            };
            animate();

            const handleResize = () => {
                if(!mountRef.current) return;
                const newWidth = mountRef.current.clientWidth;
                const newHeight = mountRef.current.clientHeight;
                if (newWidth === 0 || newHeight === 0) return;
                
                camera.aspect = newWidth / newHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(newWidth, newHeight);
            };
            
            const resizeObserver = new ResizeObserver(handleResize);
            resizeObserver.observe(mountRef.current);

            setIs3DReady(true);

            return () => {
                resizeObserver.disconnect();
                if(mountRef.current) mountRef.current.removeEventListener('mousemove', handleMouseMove);
                cancelAnimationFrame(animationFrameId);
                renderer.dispose();
                if(mountRef.current && renderer.domElement) {
                    mountRef.current.removeChild(renderer.domElement);
                }
            };
          }, []);

          // 2. Render Ulang Rak Saat Data Berubah
          useEffect(() => {
              if (!is3DReady || !sceneRef.current || !window.THREE) return;
              
              const scene = sceneRef.current;
              binsRef.current = {}; 

              const objectsToRemove = scene.children.filter(child => child.userData && child.userData.isWarehouseObject);
              objectsToRemove.forEach(obj => {
                 scene.remove(obj);
                 if(obj.geometry) obj.geometry.dispose();
                 if(obj.material) obj.material.dispose();
              });

              const frameMat = new window.THREE.MeshStandardMaterial({ color: 0xf59e0b }); 
              const shelfMat = new window.THREE.MeshStandardMaterial({ color: 0xe2e8f0 }); 
              const palletMat = new window.THREE.MeshStandardMaterial({ color: 0x8B5A2B }); 
              
              const warehouseGroup = new window.THREE.Group();
              warehouseGroup.userData.isWarehouseObject = true;
              scene.add(warehouseGroup);

              warehouseLayout.forEach((rack, rIdx) => {
                  let isPallet = rack.id === 'RB';
                  let cx, cz, rWidth, rDepth;
                  
                  if (isPallet) {
                      cx = 0; cz = 18; 
                      rWidth = 48; rDepth = 4;
                  } else {
                      cx = -22.5 + (rIdx % 10) * 5; 
                      cz = -5;
                      rWidth = 3; rDepth = 12;
                  }

                  if (isPallet) {
                      const palletGeo = new window.THREE.BoxGeometry(rWidth, 0.5, rDepth);
                      const palletMesh = new window.THREE.Mesh(palletGeo, palletMat);
                      palletMesh.position.set(cx, 0.25, cz);
                      palletMesh.castShadow = true;
                      palletMesh.receiveShadow = true;
                      warehouseGroup.add(palletMesh);

                      rack.stages.forEach((stage, sIdx) => {
                          const sy = 0.5 + sIdx * 1.5; 
                          
                          stage.bins.forEach((bin, bIdx) => {
                              const binGeo = new window.THREE.BoxGeometry(1.4, 1.4, 1.4); 
                              const binMesh = new window.THREE.Mesh(binGeo, new window.THREE.MeshStandardMaterial());
                              
                              const startX = cx - (rWidth/2) + 1.6;
                              binMesh.position.set(startX + (bIdx * 3.2), sy + 0.7, cz);
                              
                              binMesh.castShadow = true;
                              binMesh.userData = { binId: bin.name, itemsInside: [] };
                              
                              binsRef.current[bin.name] = binMesh;
                              warehouseGroup.add(binMesh);
                          });
                      });
                  } else {
                      const totalStages = rack.stages.length;
                      const rackHeight = totalStages * 3 + 1;

                      const frameGeo = new window.THREE.BoxGeometry(rWidth, rackHeight, rDepth);
                      const frameMesh = new window.THREE.Mesh(frameGeo, frameMat);
                      frameMesh.position.set(cx, rackHeight / 2, cz);
                      frameMesh.castShadow = true;
                      frameMesh.receiveShadow = true;
                      warehouseGroup.add(frameMesh);

                      rack.stages.forEach((stage, sIdx) => {
                          const sy = 1 + sIdx * 3;
                          
                          const shelfGeo = new window.THREE.BoxGeometry(rWidth + 0.2, 0.3, rDepth + 0.2);
                          const shelfMesh = new window.THREE.Mesh(shelfGeo, shelfMat);
                          shelfMesh.position.set(cx, sy, cz);
                          shelfMesh.castShadow = true;
                          warehouseGroup.add(shelfMesh);

                          stage.bins.forEach((bin, bIdx) => {
                              const binGeo = new window.THREE.BoxGeometry(1.5, 1.5, 1.5);
                              const binMesh = new window.THREE.Mesh(binGeo, new window.THREE.MeshStandardMaterial());
                              
                              const startZ = cz - (rDepth/2) + 1.2;
                              binMesh.position.set(cx, sy + 0.9, startZ + (bIdx * 2.4));
                              
                              binMesh.castShadow = true;
                              binMesh.userData = { binId: bin.name, itemsInside: [] };
                              
                              binsRef.current[bin.name] = binMesh;
                              warehouseGroup.add(binMesh);
                          });
                      });
                  }
              });

              // Map Data Item ke dalam Bin 3D
              items.forEach(item => {
                  if (item.location && binsRef.current[item.location]) {
                      binsRef.current[item.location].userData.itemsInside.push(item);
                  }
              });

              // Set Warna Bin Berdasarkan Keterisian
              Object.values(binsRef.current).forEach(binMesh => {
                  const isFilled = binMesh.userData.itemsInside.length > 0;
                  if (isFilled) {
                      binMesh.material.color.setHex(0xfacc15); // Kuning
                      binMesh.material.transparent = false;
                      binMesh.material.opacity = 1;
                      binMesh.material.depthWrite = true;
                      binMesh.userData.baseColor = 0xfacc15;
                  } else {
                      binMesh.material.color.setHex(0x94a3b8); // Abu-abu 
                      binMesh.material.transparent = true;
                      binMesh.material.opacity = 0.2; 
                      binMesh.material.depthWrite = false; 
                      binMesh.userData.baseColor = 0x94a3b8;
                  }
                  binMesh.material.needsUpdate = true; // FIX: Pastikan material diupdate mesin
              });

          }, [warehouseLayout, items, is3DReady]);

          // 3. Efek Pencarian / Highlight Glowing (Kini Lebih Robust)
          useEffect(() => {
              if (!is3DReady || !binsRef.current) return;
              
              // Hilangkan spasi agar pencarian lebih kebal typo
              const query = searchQuery.toLowerCase().replace(/\s+/g, '');
              
              Object.values(binsRef.current).forEach(binMesh => {
                  let isMatch = false;
                  
                  if (query) {
                      const bId = binMesh.userData.binId || '';
                      if (bId.toLowerCase().replace(/\s+/g, '').includes(query)) isMatch = true;
                      
                      if (binMesh.userData.itemsInside && binMesh.userData.itemsInside.length > 0) {
                          binMesh.userData.itemsInside.forEach(itm => {
                             const iId = itm.id || '';
                             const iName = itm.name || '';
                             if (iId.toLowerCase().replace(/\s+/g, '').includes(query) || iName.toLowerCase().replace(/\s+/g, '').includes(query)) {
                                 isMatch = true;
                             }
                          });
                      }
                  }

                  if (isMatch) {
                      binMesh.material.color.setHex(0xff0000); // Merah Terang
                      binMesh.material.emissive.setHex(0xff0000); // Glow Merah Terang
                      binMesh.material.emissiveIntensity = 1.0;
                      binMesh.material.transparent = false;
                      binMesh.material.opacity = 1;
                      binMesh.scale.set(1.5, 1.5, 1.5); // Membesar signifikan
                  } else {
                      // Kembalikan ke warna asli (Kuning/Transparan)
                      if(binMesh.userData.baseColor) {
                          binMesh.material.color.setHex(binMesh.userData.baseColor);
                      }
                      binMesh.material.emissive.setHex(0x000000);
                      
                      const isFilled = binMesh.userData.itemsInside && binMesh.userData.itemsInside.length > 0;
                      binMesh.material.transparent = !isFilled;
                      binMesh.material.opacity = isFilled ? 1 : 0.2;
                      binMesh.scale.set(1, 1, 1);
                  }
                  binMesh.material.needsUpdate = true; // FIX: Paksa render ulang visual
              });
          }, [searchQuery, is3DReady, items, warehouseLayout]); // Dependencies lengkap

          // Logika Form UI
          const handleAddRack = () => {
            const rackName = window.prompt('Masukkan Nama Rak Baru (Contoh: RAK D):');
            if (rackName) {
              const newRack = { id: `R${Date.now()}`, name: rackName, stages: [] };
              setWarehouseLayout([...warehouseLayout, newRack]);
              showNotification(`Rak "${rackName}" berhasil ditambahkan ke database!`);
            }
          };

          const handleAddStage = (rackId) => {
            const stageName = window.prompt('Masukkan Nama Tingkat/Level (Contoh: Lantai 3):');
            if (stageName) {
              setWarehouseLayout(warehouseLayout.map(r => r.id === rackId ? { ...r, stages: [...r.stages, { id: `S${Date.now()}`, name: stageName, bins: [] }] } : r));
              showNotification(`Level berhasil ditambahkan.`);
            }
          };

          const handleAddBin = (rackId, stageId) => {
            const binName = window.prompt('Masukkan Kode BIN/Lokasi Fisik (Contoh: D1-01):');
            if (binName) {
              setWarehouseLayout(warehouseLayout.map(rack => rack.id === rackId ? {
                ...rack, stages: rack.stages.map(stage => stage.id === stageId ? { ...stage, bins: [...stage.bins, { id: `B${Date.now()}`, name: binName }] } : stage)
              } : rack));
              showNotification(`Lokasi Fisik (BIN) ditambahkan.`);
            }
          };

          return (
            <div className="space-y-4 animate-in fade-in duration-300 font-sans h-[calc(100vh-120px)] flex flex-col">
              <div className="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 border-b dark:border-gray-800 pb-4 shrink-0">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                    <MapIcon size={24} className="text-pink-500" /> Virtual Warehouse 3D
                  </h2>
                  <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">Gunakan mouse/sentuhan untuk memutar kamera. Ketik kode untuk mencari.</p>
                </div>
                <div className="flex gap-2 w-full md:w-auto">
                  <div className="relative w-full md:w-80">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-blue-500" size={16} />
                    <input 
                      type="text" 
                      placeholder="Cari ID Material (ITM-0002)..." 
                      className="w-full pl-10 pr-4 py-2 border-2 border-blue-400 bg-white dark:bg-gray-900 dark:text-white rounded-xl outline-none focus:ring-4 focus:ring-blue-500/30 font-sans text-sm font-bold shadow-lg transition-all"
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                    />
                  </div>
                </div>
              </div>

              <div className="flex flex-col lg:flex-row gap-4 flex-1 min-h-0">
                {/* 3D Canvas Area */}
                <div className="flex-1 bg-slate-100 dark:bg-gray-900 rounded-2xl border-4 border-gray-200 dark:border-gray-800 overflow-hidden shadow-inner relative group min-h-[400px]">
                    <div ref={mountRef} className="absolute inset-0 cursor-grab active:cursor-grabbing"></div>
                    
                    {/* Tooltip Kustom 3D dengan inline style display agar aman dari Tailwind CSS override */}
                    <div ref={tooltipRef} style={{ display: 'none' }} className="absolute pointer-events-none bg-gray-900/95 text-white p-3 rounded-xl z-50 shadow-2xl backdrop-blur-md border border-gray-700 min-w-[160px] transform transition-none"></div>

                    <div className="absolute bottom-4 right-4 bg-white/80 dark:bg-gray-800/80 backdrop-blur px-3 py-2 rounded-lg text-[10px] font-bold text-gray-500 uppercase tracking-widest pointer-events-none shadow z-10 flex items-center gap-2">
                       <Info size={14}/> Scroll = Zoom | Click+Drag = Rotate | Hover = Detail
                    </div>
                </div>

                {/* Struktur Rak Editor (Kanan) */}
                <div className="w-full lg:w-80 bg-white dark:bg-gray-900 border dark:border-gray-800 rounded-2xl shadow-sm flex flex-col shrink-0 overflow-hidden">
                   <div className="p-4 border-b dark:border-gray-800 bg-gray-50/50 dark:bg-gray-900/50 flex justify-between items-center">
                     <h3 className="font-bold text-sm uppercase tracking-wider text-gray-700 dark:text-gray-300">Layout Editor</h3>
                     <button onClick={handleAddRack} className="text-blue-600 hover:text-blue-800"><PlusCircle size={20}/></button>
                   </div>
                   
                   <div className="flex-1 overflow-y-auto p-4 space-y-4">
                     {warehouseLayout.map(rack => (
                        <div key={rack.id} className="border border-gray-200 dark:border-gray-700 rounded-xl p-3 bg-gray-50 dark:bg-gray-800/50">
                           <div className="flex justify-between items-center mb-3">
                             <span className="font-bold text-sm text-gray-800 dark:text-gray-200 flex items-center gap-2"><BoxIcon size={14} className="text-amber-500"/> {rack.name}</span>
                             <button onClick={() => handleAddStage(rack.id)} className="text-gray-400 hover:text-green-600 transition-colors" title="Tambah Level"><Plus size={16}/></button>
                           </div>
                           
                           <div className="space-y-2">
                             {rack.stages.map(stage => (
                               <div key={stage.id} className="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-2">
                                 <div className="flex justify-between items-center border-b border-gray-100 dark:border-gray-800 pb-1 mb-2">
                                   <span className="text-[10px] font-bold uppercase text-gray-500">{stage.name}</span>
                                   <button onClick={() => handleAddBin(rack.id, stage.id)} className="text-gray-400 hover:text-blue-600"><Plus size={12}/></button>
                                 </div>
                                 <div className="flex flex-wrap gap-1">
                                    {stage.bins.length === 0 && <span className="text-[9px] text-gray-400 italic">Kosong</span>}
                                    {stage.bins.map(bin => {
                                       // Cek isi bin
                                       const binItems = items.filter(i => i.location === bin.name);
                                       const isFilled = binItems.length > 0;
                                       
                                       // FIX: Cek juga apakah query pencarian cocok dengan ID atau Nama Item secara kuat (hilangkan spasi)
                                       const q = searchQuery.toLowerCase().replace(/\s+/g, '');
                                       const isSearched = q && (
                                           bin.name.toLowerCase().replace(/\s+/g, '').includes(q) || 
                                           binItems.some(itm => 
                                              (itm.id && itm.id.toLowerCase().replace(/\s+/g, '').includes(q)) || 
                                              (itm.name && itm.name.toLowerCase().replace(/\s+/g, '').includes(q))
                                           )
                                       );
                                       
                                       // Logika pewarnaan
                                       let colorClass = 'bg-gray-100 border-gray-300 text-gray-500 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400'; // Kosong
                                       if (isSearched) {
                                           colorClass = 'bg-red-100 border-red-500 text-red-700 animate-pulse';
                                       } else if (isFilled) {
                                           colorClass = 'bg-green-100 border-green-400 text-green-700 dark:bg-green-900/40 dark:border-green-700 dark:text-green-400';
                                       }

                                       return (
                                         <span key={bin.id} className={`text-[9px] font-mono font-bold px-1.5 py-0.5 rounded border transition-colors ${colorClass}`} title={isFilled ? `Ada ${binItems.length} SKU` : 'Kosong'}>
                                           {bin.name}
                                         </span>
                                       );
                                    })}
                                 </div>
                               </div>
                             ))}
                           </div>
                        </div>
                     ))}
                   </div>
                </div>
              </div>

            </div>
          );
        };

        // --- VIEW: MASTER ITEM ---
        const MasterItemView = ({ items, setItems, showNotification, adminPassword, warehouseLayout }) => {
          const [searchTerm, setSearchTerm] = useState('');
          const [isAddModalOpen, setIsAddModalOpen] = useState(false);
          const [selectedItemDetail, setSelectedItemDetail] = useState(null); 
          const [newItem, setNewItem] = useState({ name: '', category: 'Mechanical', partNo: '', unit: 'PCS', stock: 0, minStock: 0, price: 0, location: '', specs: '' });

          const [authModal, setAuthModal] = useState({ isOpen: false, action: null, item: null });
          const [passwordInput, setPasswordInput] = useState('');
          const [showPassword, setShowPassword] = useState(false); 
          const [editItem, setEditItem] = useState(null);

          const fileInputRef = useRef(null);
          const [isSyncModalOpen, setIsSyncModalOpen] = useState(false);
          const [sheetUrl, setSheetUrl] = useState('');

          // Menarik data seluruh BIN dari Virtual Warehouse untuk fitur Autocomplete
          const allBins = useMemo(() => {
              if(!warehouseLayout) return [];
              return warehouseLayout.flatMap(rack => rack.stages.flatMap(stage => stage.bins.map(b => b.name)));
          }, [warehouseLayout]);

          const filteredItems = items.filter(item => 
            item.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
            item.id.toLowerCase().includes(searchTerm.toLowerCase())
          );

          const handleAddItem = (e) => {
            e.preventDefault();
            if (!newItem.name || !newItem.partNo || !newItem.unit || !newItem.location) {
               showNotification('Mohon lengkapi field wajib!', 'error');
               return;
            }
            const id = `ITM-${(items.length + 1001).toString()}`;
            setItems([...items, { ...newItem, id, maxStock: 100, status: 'Active' }]);
            setIsAddModalOpen(false);
            showNotification('Item berhasil ditambahkan!');
            setNewItem({ name: '', category: 'Mechanical', partNo: '', unit: 'PCS', stock: 0, minStock: 0, price: 0, location: '', specs: '' });
          };

          const handleAuthSubmit = (e) => {
            e.preventDefault();
            if (passwordInput === adminPassword) {
              const { action, item } = authModal;
              setAuthModal({ isOpen: false, action: null, item: null });
              setPasswordInput('');
              
              if (action === 'delete') {
                setItems(items.filter(i => i.id !== item.id));
                showNotification(`Material ${item.id} berhasil dihapus dari database.`);
              } else if (action === 'edit') {
                setEditItem({ ...item });
              }
            } else {
              showNotification('Password otoritas salah!', 'error');
            }
          };

          const handleEditSubmit = (e) => {
            e.preventDefault();
            setItems(items.map(item => item.id === editItem.id ? editItem : item));
            setEditItem(null);
            showNotification(`Data material ${editItem.id} berhasil diperbarui.`);
          };

          const handleExportExcel = () => {
            let tableStr = '<tr><th>ID Item</th><th>Nama Barang</th><th>Part Number</th><th>Kategori</th><th>UOM</th><th>Stok</th><th>Harga Satuan</th><th>Total (IDR)</th><th>Lokasi BIN</th><th>Spesifikasi</th></tr>';
            filteredItems.forEach(item => {
              tableStr += `<tr>
                <td>${item.id}</td><td>${item.name}</td><td>${item.partNo}</td>
                <td>${item.category}</td><td>${item.unit}</td><td>${item.stock}</td>
                <td>${item.price || 0}</td><td>${(item.stock || 0) * (item.price || 0)}</td>
                <td>${item.location}</td><td>${item.specs || ''}</td>
              </tr>`;
            });
            const content = `<table border="1">${tableStr}</table>`;
            const blob = new Blob([content], { type: 'application/vnd.ms-excel' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Master_Material_${new Date().getTime()}.xls`;
            link.click();
            showNotification('Data berhasil diekspor ke Excel.');
          };

          const processImportedData = (data) => {
             const newItems = data.map((row, idx) => ({
                id: row['ID Item'] || `ITM-MIG-${Math.floor(Math.random()*10000)}-${idx}`,
                name: row['Nama Barang'] || 'Unknown Item',
                category: row['Kategori'] || 'Mechanical',
                partNo: row['Part Number'] || '-',
                unit: row['UOM'] || 'PCS',
                stock: Number(row['Stok']) || 0,
                minStock: 10,
                maxStock: 100,
                price: Number(row['Harga Satuan']) || 0,
                location: row['Lokasi BIN'] || '-',
                status: 'Active',
                specs: row['Spesifikasi'] || ''
             }));
             setItems(prev => [...newItems, ...prev]);
             showNotification(`${newItems.length} data material berhasil diimpor!`);
          };

          const handleFileUpload = (e) => {
             const file = e.target.files[0];
             if (!file) return;
             const reader = new FileReader();
             reader.onload = (evt) => {
                try {
                   const bstr = evt.target.result;
                   const wb = window.XLSX.read(bstr, {type: 'binary'});
                   const wsname = wb.SheetNames[0];
                   const ws = wb.Sheets[wsname];
                   const data = window.XLSX.utils.sheet_to_json(ws);
                   processImportedData(data);
                } catch (error) {
                   showNotification('Gagal membaca file Excel. Pastikan format sesuai.', 'error');
                }
             };
             reader.readAsBinaryString(file);
             e.target.value = null;
          };

          const handleSyncSheet = async (e) => {
             e.preventDefault();
             if(!sheetUrl.includes('pub?output=csv')) {
                 showNotification('URL tidak valid. Gunakan URL Publish to Web (format CSV).', 'error');
                 return;
             }
             try {
                const response = await fetch(sheetUrl);
                const csvText = await response.text();
                const wb = window.XLSX.read(csvText, {type: 'string'});
                const ws = wb.Sheets[wb.SheetNames[0]];
                const data = window.XLSX.utils.sheet_to_json(ws);
                processImportedData(data);
                setIsSyncModalOpen(false);
                setSheetUrl('');
             } catch (error) {
                 showNotification('Gagal menarik data dari Spreadsheet.', 'error');
             }
          };

          return (
            <div className="space-y-6 animate-in fade-in duration-300">
              
              {/* Datalist Global untuk Autocomplete Lokasi BIN */}
              <datalist id="warehouse-bins">
                 {allBins.map(binName => <option key={binName} value={binName} />)}
              </datalist>

              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Master Material</h2>
                  <p className="text-gray-500 dark:text-gray-400">Database spare part dan inventaris sistem</p>
                </div>
                <div className="flex flex-wrap gap-2">
                  <input type="file" accept=".xlsx, .xls, .csv" ref={fileInputRef} className="hidden" onChange={handleFileUpload} />
                  <Button variant="outline" icon={LinkIcon} onClick={() => setIsSyncModalOpen(true)} className="hidden sm:flex">Sync Sheet</Button>
                  <Button variant="outline" icon={Upload} onClick={() => fileInputRef.current?.click()}>Upload Excel</Button>
                  <Button variant="outline" icon={FileBarChart} onClick={handleExportExcel}>Export Excel</Button>
                  <Button icon={Plus} onClick={() => setIsAddModalOpen(true)}>Tambah Item</Button>
                </div>
              </div>

              <div className="bg-white dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm overflow-hidden font-sans">
                <div className="p-4 border-b dark:border-gray-700 bg-gray-50/30 dark:bg-gray-900/30 flex items-center">
                  <div className="relative w-full max-w-md">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={16} />
                    <input 
                      type="text" 
                      placeholder="Cari material atau kode..." 
                      className="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-900 outline-none text-sm font-sans"
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                    />
                  </div>
                </div>
                
                <div className="overflow-x-auto">
                  <table className="w-full text-sm text-left whitespace-nowrap">
                    <thead className="bg-gray-50/50 dark:bg-gray-900 text-xs font-bold uppercase text-gray-500 dark:text-gray-400">
                      <tr>
                        <th className="px-6 py-4 font-sans">ID Item</th>
                        <th className="px-6 py-4 font-sans">Nama Barang</th>
                        <th className="px-6 py-4 font-sans">Kategori</th>
                        <th className="px-6 py-4 text-center font-sans">UOM</th>
                        <th className="px-6 py-4 text-center font-sans">Stok</th>
                        <th className="px-6 py-4 text-right font-sans">Harga Satuan</th>
                        <th className="px-6 py-4 text-right font-sans">Total (IDR)</th>
                        <th className="px-6 py-4 font-sans">Lokasi BIN</th>
                        <th className="px-6 py-4 text-right font-sans">Aksi</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y dark:divide-gray-700">
                      {filteredItems.map(item => (
                        <tr key={item.id} className="hover:bg-gray-50/50 dark:hover:bg-gray-800/30 transition-colors">
                          <td className="px-6 py-4 font-bold text-blue-600 dark:text-blue-400">
                            <button onClick={() => setSelectedItemDetail(item)} className="hover:underline">{item.id}</button>
                          </td>
                          <td className="px-6 py-4">
                            <p className="font-bold text-gray-900 dark:text-white font-sans">{item.name}</p>
                            <p className="text-[10px] text-gray-400 uppercase font-bold tracking-wider">PN: {item.partNo}</p>
                          </td>
                          <td className="px-6 py-4">
                            <span className="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-[10px] font-bold uppercase">{item.category}</span>
                          </td>
                          <td className="px-6 py-4 text-center font-sans">{item.unit}</td>
                          <td className={`px-6 py-4 text-center font-bold text-base font-sans ${item.stock <= item.minStock ? 'text-red-600' : 'text-green-600'}`}>
                            {item.stock}
                          </td>
                          <td className="px-6 py-4 text-right font-mono text-sm text-gray-600 dark:text-gray-300">
                            {item.price?.toLocaleString('id-ID') || 0}
                          </td>
                          <td className="px-6 py-4 text-right font-mono font-bold text-sm text-gray-900 dark:text-white">
                            {((item.stock || 0) * (item.price || 0)).toLocaleString('id-ID')}
                          </td>
                          <td className="px-6 py-4 font-mono text-gray-500">{item.location}</td>
                          <td className="px-6 py-4 text-right">
                            <div className="flex justify-end gap-2 font-sans">
                               <button onClick={() => setAuthModal({ isOpen: true, action: 'edit', item })} className="flex items-center gap-1.5 px-2.5 py-1.5 bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400 hover:bg-blue-100 rounded-lg transition-colors" title="Edit Data">
                                 <Edit size={14}/> <span className="text-[10px] font-bold uppercase hidden sm:inline">Edit</span>
                               </button>
                               <button onClick={() => setAuthModal({ isOpen: true, action: 'delete', item })} className="flex items-center gap-1.5 px-2.5 py-1.5 bg-red-50 text-red-600 dark:bg-red-900/30 dark:text-red-400 hover:bg-red-100 rounded-lg transition-colors" title="Hapus Data">
                                 <Trash2 size={14}/> <span className="text-[10px] font-bold uppercase hidden sm:inline">Hapus</span>
                               </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Modal Otorisasi Password */}
              {authModal.isOpen && (
                <div className="fixed inset-0 bg-black/70 z-[110] flex items-center justify-center p-4 backdrop-blur-sm">
                  <div className="bg-white dark:bg-gray-900 rounded-xl w-full max-w-sm overflow-hidden shadow-2xl animate-in zoom-in-95 duration-200">
                    <div className="p-4 border-b dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-gray-950">
                      <h3 className="font-bold dark:text-white flex items-center gap-2">
                        <Settings size={18} className="text-blue-600" />
                        Otorisasi Keamanan
                      </h3>
                      <button onClick={() => { setAuthModal({ isOpen: false, action: null, item: null }); setPasswordInput(''); }} className="text-gray-400 hover:text-red-600"><X size={20}/></button>
                    </div>
                    <form onSubmit={handleAuthSubmit} className="p-6 space-y-5">
                      <p className="text-sm text-gray-500 dark:text-gray-400">
                        Masukkan password admin untuk <strong>{authModal.action === 'edit' ? 'mengubah' : 'menghapus'}</strong> data {authModal.item?.id}.
                      </p>
                      <div className="relative">
                        <input 
                          type={showPassword ? "text" : "password"} 
                          autoFocus
                          placeholder="Ketik password (admin123)..."
                          required
                          className="w-full p-3 pr-10 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-950 dark:text-white outline-none focus:ring-2 focus:ring-blue-500" 
                          value={passwordInput} 
                          onChange={e => setPasswordInput(e.target.value)} 
                        />
                        <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                          {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                        </button>
                      </div>
                      <div className="flex justify-end gap-2 pt-2">
                        <Button variant="outline" onClick={() => { setAuthModal({ isOpen: false, action: null, item: null }); setPasswordInput(''); setShowPassword(false); }}>Batal</Button>
                        <Button type="submit" variant={authModal.action === 'delete' ? 'danger' : 'primary'}>Konfirmasi</Button>
                      </div>
                    </form>
                  </div>
                </div>
              )}

              {/* Modal Edit Item */}
              {editItem && (
                <div className="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
                   <div className="bg-white dark:bg-gray-900 rounded-2xl w-full max-w-2xl overflow-hidden shadow-2xl">
                     <div className="p-6 border-b dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-gray-950 font-sans">
                        <h3 className="text-lg font-bold dark:text-white flex items-center gap-2"><Edit size={18} className="text-blue-500"/> Edit Material: {editItem.id}</h3>
                        <button onClick={() => setEditItem(null)} className="text-gray-400 hover:text-red-600"><X size={24}/></button>
                     </div>
                     <form onSubmit={handleEditSubmit} className="p-6 grid grid-cols-1 md:grid-cols-2 gap-5 font-sans">
                        <div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Nama Barang *</label><input type="text" required className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-950 dark:text-white outline-none focus:border-blue-500" value={editItem.name} onChange={e => setEditItem({...editItem, name: e.target.value})} /></div>
                        <div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Part Number *</label><input type="text" required className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-950 dark:text-white outline-none focus:border-blue-500" value={editItem.partNo} onChange={e => setEditItem({...editItem, partNo: e.target.value})} /></div>
                        <div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Kategori</label><select className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-950 dark:text-white outline-none focus:border-blue-500" value={editItem.category} onChange={e => setEditItem({...editItem, category: e.target.value})}><option>Mechanical</option><option>Electrical</option><option>Chemical</option></select></div>
                        <div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Satuan (UOM)</label><input type="text" required className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-950 dark:text-white outline-none focus:border-blue-500" value={editItem.unit} onChange={e => setEditItem({...editItem, unit: e.target.value})} /></div>
                        <div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Stok (Update Manual)</label><input type="number" required className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-950 dark:text-white outline-none focus:border-blue-500" value={editItem.stock} onChange={e => setEditItem({...editItem, stock: Number(e.target.value)})} /></div>
                        <div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Harga Satuan (Rp)</label><input type="number" required className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-950 dark:text-white outline-none focus:border-blue-500" value={editItem.price} onChange={e => setEditItem({...editItem, price: Number(e.target.value)})} /></div>
                        <div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Lokasi BIN *</label><input list="warehouse-bins" type="text" required className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-950 dark:text-white outline-none focus:border-blue-500" value={editItem.location} onChange={e => setEditItem({...editItem, location: e.target.value})} placeholder="Pilih atau ketik lokasi..." /></div>
                        <div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Spesifikasi</label><input type="text" className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-950 dark:text-white outline-none focus:border-blue-500" value={editItem.specs} onChange={e => setEditItem({...editItem, specs: e.target.value})} /></div>
                        <div className="md:col-span-2 pt-4 flex justify-end gap-3"><Button variant="outline" onClick={() => setEditItem(null)}>Batal</Button><Button type="submit">Simpan Perubahan</Button></div>
                     </form>
                   </div>
                </div>
              )}

              {/* Modal Add Item */}
              {isAddModalOpen && (
                <div className="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
                   <div className="bg-white dark:bg-gray-900 rounded-2xl w-full max-w-2xl overflow-hidden shadow-2xl">
                     <div className="p-6 border-b dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-gray-950 font-sans">
                        <h3 className="text-lg font-bold dark:text-white">Tambah Material Baru</h3>
                        <button onClick={() => setIsAddModalOpen(false)} className="text-gray-400 hover:text-red-600"><X size={24}/></button>
                     </div>
                     <form onSubmit={handleAddItem} className="p-6 grid grid-cols-1 md:grid-cols-2 gap-5 font-sans">
                        <div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Nama Barang *</label><input type="text" required className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-950 dark:text-white outline-none focus:border-blue-500" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} /></div>
                        <div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Part Number *</label><input type="text" required className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-950 dark:text-white outline-none focus:border-blue-500" value={newItem.partNo} onChange={e => setNewItem({...newItem, partNo: e.target.value})} /></div>
                        <div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Kategori</label><select className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-950 dark:text-white outline-none" value={newItem.category} onChange={e => setNewItem({...newItem, category: e.target.value})}><option>Mechanical</option><option>Electrical</option><option>Chemical</option></select></div>
                        <div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Satuan (UOM)</label><input type="text" required className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-950 dark:text-white outline-none" value={newItem.unit} onChange={e => setNewItem({...newItem, unit: e.target.value})} /></div>
                        <div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Stok Awal</label><input type="number" required className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-950 dark:text-white outline-none" value={newItem.stock} onChange={e => setNewItem({...newItem, stock: Number(e.target.value)})} /></div>
                        <div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Harga Satuan (Rp)</label><input type="number" required className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-950 dark:text-white outline-none" value={newItem.price} onChange={e => setNewItem({...newItem, price: Number(e.target.value)})} /></div>
                        <div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Lokasi BIN *</label><input list="warehouse-bins" type="text" required className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-950 dark:text-white outline-none" placeholder="Pilih atau ketik lokasi (Cth: R1-1-1)" value={newItem.location} onChange={e => setNewItem({...newItem, location: e.target.value})} /></div>
                        <div className="md:col-span-2 pt-4 flex justify-end gap-3"><Button variant="outline" onClick={() => setIsAddModalOpen(false)}>Batal</Button><Button type="submit">Simpan Item</Button></div>
                     </form>
                   </div>
                </div>
              )}

              {/* Modal Detail Item */}
              {selectedItemDetail && (
                <div className="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
                   <div className="bg-white dark:bg-gray-900 rounded-2xl w-full max-w-lg overflow-hidden shadow-2xl font-sans">
                      <div className="p-6 border-b dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-gray-950">
                         <h3 className="text-lg font-bold dark:text-white font-sans">Detail Material: {selectedItemDetail.id}</h3>
                         <button onClick={() => setSelectedItemDetail(null)} className="text-gray-400 hover:text-red-600"><X size={24}/></button>
                      </div>
                      <div className="p-8 flex flex-col items-center">
                         <div className="w-40 h-40 bg-gray-100 dark:bg-gray-800 rounded-2xl flex items-center justify-center text-gray-300 border-2 border-dashed border-gray-200 dark:border-gray-700 mb-6"><ImageIcon size={48}/></div>
                         <h4 className="text-xl font-bold dark:text-white text-center font-sans">{selectedItemDetail.name}</h4>
                         <p className="text-xs font-bold text-gray-400 uppercase tracking-widest mt-1">Part Number: {selectedItemDetail.partNo}</p>
                         <div className="grid grid-cols-2 gap-4 w-full mt-8">
                            <div className="p-4 bg-gray-50 dark:bg-gray-950 rounded-xl border dark:border-gray-800"><p className="text-[10px] font-bold uppercase text-gray-400">Stok Saat Ini</p><p className="text-xl font-bold text-blue-600">{selectedItemDetail.stock} {selectedItemDetail.unit}</p></div>
                            <div className="p-4 bg-gray-50 dark:bg-gray-950 rounded-xl border dark:border-gray-800"><p className="text-[10px] font-bold uppercase text-gray-400">Lokasi BIN</p><p className="text-xl font-bold dark:text-white uppercase">{selectedItemDetail.location}</p></div>
                         </div>
                         <div className="w-full mt-6 p-4 border rounded-xl dark:border-gray-800 text-sm text-gray-500 italic">Spesifikasi: {selectedItemDetail.specs || '-'}</div>
                      </div>
                   </div>
                </div>
              )}
            </div>
          );
        };

        // --- VIEW: MASTER SUPPLIER ---
        const MasterSupplierView = ({ suppliers }) => {
          return (
            <div className="space-y-6 animate-in fade-in duration-300">
              <div className="flex justify-between items-end">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Master Supplier</h2>
                  <p className="text-gray-500 dark:text-gray-400">Manajemen mitra pemasok material</p>
                </div>
                <Button icon={Plus}>Tambah Supplier</Button>
              </div>
              <div className="bg-white dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm overflow-hidden font-sans">
                <table className="w-full text-sm text-left">
                  <thead className="bg-gray-50/50 dark:bg-gray-900 text-xs font-bold uppercase text-gray-500 dark:text-gray-400">
                    <tr>
                      <th className="px-6 py-4 font-sans">ID</th>
                      <th className="px-6 py-4 font-sans">Nama Perusahaan</th>
                      <th className="px-6 py-4 font-sans">Kontak</th>
                      <th className="px-6 py-4 font-sans">Email</th>
                      <th className="px-6 py-4 font-sans">Status</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y dark:divide-gray-700">
                    {suppliers.map(s => (
                      <tr key={s.id} className="hover:bg-gray-50/50 dark:hover:bg-gray-800/30 font-sans">
                        <td className="px-6 py-4 font-bold text-gray-500">{s.id}</td>
                        <td className="px-6 py-4 font-bold text-gray-900 dark:text-white">{s.name}</td>
                        <td className="px-6 py-4 font-mono">{s.contact}</td>
                        <td className="px-6 py-4 font-sans">{s.email}</td>
                        <td className="px-6 py-4 font-sans">
                          <span className="px-2 py-1 bg-green-100 text-green-700 text-[10px] font-bold rounded uppercase">Aktif</span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          );
        };

        // --- VIEW: MASTER USER ---
        const MasterUserView = ({ users }) => {
          return (
            <div className="space-y-6 animate-in fade-in duration-300">
              <div className="flex justify-between items-end font-sans">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900 dark:text-white font-sans">Akses Sistem</h2>
                  <p className="text-gray-500 dark:text-gray-400 font-sans">Manajemen akun dan hak akses pengguna</p>
                </div>
                <Button icon={Users} variant="outline" className="font-sans">Otoritas Role</Button>
              </div>
              <div className="bg-white dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm overflow-hidden font-sans">
                <table className="w-full text-sm text-left">
                  <thead className="bg-gray-50/50 dark:bg-gray-900 text-xs font-bold uppercase text-gray-500 dark:text-gray-400 font-sans">
                    <tr>
                      <th className="px-6 py-4">Nama Pengguna</th>
                      <th className="px-6 py-4">Jabatan/Role</th>
                      <th className="px-6 py-4">Departemen</th>
                      <th className="px-6 py-4 text-right">Aksi</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y dark:divide-gray-700 font-sans">
                    {users.map(u => (
                      <tr key={u.id} className="hover:bg-gray-50/50 dark:hover:bg-gray-800/30">
                        <td className="px-6 py-4 font-bold text-gray-900 dark:text-white">{u.name}</td>
                        <td className="px-6 py-4 text-blue-600 font-medium font-sans">{u.role}</td>
                        <td className="px-6 py-4 font-sans">{u.dept}</td>
                        <td className="px-6 py-4 text-right font-sans">
                          <button className="p-1 hover:text-blue-600 transition-colors"><Edit size={16}/></button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          );
        };

        // --- VIEW: LOG TRANSAKSI ---
        const TransactionLogView = ({ transactions, items }) => {
          return (
            <div className="space-y-6 animate-in fade-in duration-300">
              <div className="flex justify-between items-end font-sans">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900 dark:text-white font-sans">Laporan Transaksi</h2>
                  <p className="text-gray-500 dark:text-gray-400 font-sans">Log riwayat masuk dan keluar material</p>
                </div>
              </div>
              <div className="bg-white dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm overflow-hidden font-sans">
                <div className="overflow-x-auto">
                  <table className="w-full text-sm text-left whitespace-nowrap">
                    <thead className="bg-gray-50/50 dark:bg-gray-900 text-xs font-bold uppercase text-gray-500 dark:text-gray-400 font-sans">
                      <tr>
                        <th className="px-6 py-4">ID Transaksi</th>
                        <th className="px-6 py-4">Waktu</th>
                        <th className="px-6 py-4">Tipe</th>
                        <th className="px-6 py-4">Material</th>
                        <th className="px-6 py-4">Qty</th>
                        <th className="px-6 py-4">Referensi</th>
                        <th className="px-6 py-4">User</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y dark:divide-gray-700 font-sans">
                      {transactions.map(t => {
                        const trItem = items.find(i => i.id === t.itemId);
                        return (
                          <tr key={t.id} className="hover:bg-gray-50/50 dark:hover:bg-gray-800/30">
                            <td className="px-6 py-4 font-bold text-gray-500">{t.id}</td>
                            <td className="px-6 py-4 font-mono text-xs">{t.date}</td>
                            <td className="px-6 py-4">
                              <span className={`px-2 py-1 text-[10px] font-bold rounded uppercase ${t.type === 'IN' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}`}>
                                {t.type === 'IN' ? 'Masuk' : 'Keluar'}
                              </span>
                            </td>
                            <td className="px-6 py-4">
                              <p className="font-bold text-gray-900 dark:text-white">{trItem?.name || 'Unknown'}</p>
                              <p className="text-[10px] text-gray-400 font-bold uppercase">{t.itemId}</p>
                            </td>
                            <td className={`px-6 py-4 font-bold text-center ${t.type === 'IN' ? 'text-green-600' : 'text-orange-600'}`}>
                              {t.type === 'IN' ? '+' : '-'}{t.qty}
                            </td>
                            <td className="px-6 py-4 font-mono text-xs text-gray-500">{t.ref}</td>
                            <td className="px-6 py-4">{t.user}</td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          );
        };

        // --- VIEW: STOCK OPNAME ---
        const StockOpnameView = ({ items, setItems, transactions, setTransactions, showNotification }) => {
          const [selectedId, setSelectedId] = useState('');
          const [actualQty, setActualQty] = useState('');
          const [notes, setNotes] = useState('');
          const [isScannerOpen, setIsScannerOpen] = useState(false);
          const [isScriptLoaded, setIsScriptLoaded] = useState(false);
          const scannerRef = useRef(null);

          const selectedItem = items.find(i => i.id === selectedId);
          const diff = selectedItem && actualQty !== '' ? Number(actualQty) - selectedItem.stock : 0;

          useEffect(() => {
            if (window.Html5Qrcode) { setIsScriptLoaded(true); return; }
            const script = document.createElement('script');
            script.src = "https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js";
            script.async = true;
            script.onload = () => setIsScriptLoaded(true);
            document.body.appendChild(script);
          }, []);

          const handleAdjustment = (e) => {
            e.preventDefault();
            if(!selectedItem || actualQty === '') return;
            if(diff !== 0 && !notes) { showNotification('Alasan selisih wajib diisi!', 'error'); return; }

            const updatedItems = items.map(item => item.id === selectedId ? { ...item, stock: Number(actualQty) } : item);
            const now = new Date();
            const newTrx = {
              id: `ADJ-${1000 + transactions.length + 1}`,
              date: `${now.toLocaleDateString('id-ID')} ${now.toLocaleTimeString('id-ID')}`,
              type: diff > 0 ? 'IN' : 'OUT',
              itemId: selectedId,
              qty: Math.abs(diff),
              user: 'Admin SPMS',
              ref: 'STOCK-OPNAME',
              dept: notes || 'Verifikasi Sesuai'
            };
            setItems(updatedItems);
            setTransactions([newTrx, ...transactions]);
            showNotification('Adjustment stok berhasil disimpan.');
            setSelectedId(''); setActualQty(''); setNotes('');
          };

          const safeStopScanner = () => { 
            if (scannerRef.current) { 
              try {
                if (scannerRef.current.getState() === 2) {
                  scannerRef.current.stop().catch(() => {});
                }
              } catch (error) {}
              scannerRef.current = null; 
            } 
          };

          useEffect(() => {
            if (isScannerOpen && isScriptLoaded) {
              setTimeout(() => {
                try {
                  const html5QrCode = new window.Html5Qrcode("opname-qr-reader");
                  scannerRef.current = html5QrCode;
                  html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => { safeStopScanner(); setSelectedId(text); setIsScannerOpen(false); }, () => {}).catch(() => {});
                } catch (e) {}
              }, 400);
            }
            return () => safeStopScanner();
          }, [isScannerOpen, isScriptLoaded]);

          return (
            <div className="max-w-4xl mx-auto space-y-8 animate-in fade-in duration-300 font-sans">
               <div className="flex items-center justify-between border-b dark:border-gray-800 pb-4">
                  <h2 className="text-2xl font-bold dark:text-white">Stock Opname</h2>
                  <p className="text-sm text-gray-500 font-sans">Penyesuaian stok fisik dan sistem</p>
               </div>
               <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                  <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl border dark:border-gray-800 shadow-sm space-y-6">
                     <Button variant="outline" className="w-full !py-3 font-bold" icon={QrCode} onClick={() => setIsScannerOpen(true)}>Scan QR / Barcode</Button>
                     <div className="relative flex items-center justify-center text-[10px] font-bold uppercase text-gray-400 font-sans">
                        <div className="absolute inset-0 flex items-center font-sans"><div className="w-full border-t dark:border-gray-700"></div></div>
                        <span className="relative bg-white dark:bg-gray-800 px-2 uppercase tracking-widest font-sans">Atau Manual</span>
                     </div>
                     <select className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-950 dark:text-white outline-none focus:border-blue-500 font-sans" value={selectedId} onChange={e => setSelectedId(e.target.value)}>
                        <option value="">-- Pilih Material --</option>
                        {items.map(item => <option key={item.id} value={item.id}>{item.id} - {item.name}</option>)}
                     </select>
                  </div>
                  <div className="md:col-span-2 bg-white dark:bg-gray-800 p-8 rounded-2xl border dark:border-gray-800 shadow-sm min-h-[300px] flex items-center justify-center">
                     {!selectedItem ? <div className="text-center opacity-30 italic text-gray-400 font-sans">Pilih material untuk memulai penyesuaian stok.</div> : (
                       <form onSubmit={handleAdjustment} className="w-full space-y-8 font-sans">
                          <div className="text-center font-sans"><h3 className="text-xl font-bold dark:text-white font-sans">{selectedItem.name}</h3><p className="text-xs text-gray-500 uppercase tracking-widest font-sans">Lokasi: {selectedItem.location}</p></div>
                          <div className="grid grid-cols-3 gap-6 font-sans">
                             <div className="text-center p-4 bg-gray-50 dark:bg-gray-900 rounded-xl font-sans"><p className="text-[10px] font-bold text-gray-400 uppercase mb-1 font-sans">Sistem</p><p className="text-2xl font-bold dark:text-white font-sans">{selectedItem.stock}</p></div>
                             <div className="text-center p-4 bg-blue-50 dark:bg-blue-900/10 rounded-xl border border-blue-100 dark:border-blue-800 font-sans"><p className="text-[10px] font-bold text-blue-600 uppercase mb-1 font-sans">Fisik Aktuil</p><input type="number" className="w-full text-center bg-transparent text-2xl font-bold text-blue-600 outline-none font-sans" placeholder="0" value={actualQty} onChange={e => setActualQty(e.target.value)} /></div>
                             <div className={`text-center p-4 rounded-xl font-sans ${diff === 0 ? 'bg-gray-50 dark:bg-gray-900' : 'bg-red-50 dark:bg-red-900/10'}`}><p className={`text-[10px] font-bold uppercase mb-1 font-sans ${diff === 0 ? 'text-gray-400' : 'text-red-500'}`}>Selisih</p><p className={`text-2xl font-bold font-sans ${diff === 0 ? 'dark:text-white' : 'text-red-600'}`}>{diff > 0 ? '+' : ''}{diff}</p></div>
                          </div>
                          {diff !== 0 && <div className="space-y-1 font-sans"><label className="text-xs font-bold text-gray-400 uppercase pl-1 font-sans">Alasan Penyesuaian *</label><input type="text" className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-950 dark:text-white outline-none font-sans" placeholder="Contoh: Salah hitung, Barang rusak..." value={notes} onChange={e => setNotes(e.target.value)} /></div>}
                          <div className="flex justify-end pt-4 font-sans"><Button type="submit" className="px-8 font-sans">{diff === 0 ? 'Verifikasi Sesuai' : 'Simpan Perubahan'}</Button></div>
                       </form>
                     )}
                  </div>
               </div>

               {isScannerOpen && (
                  <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
                     <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md overflow-hidden shadow-2xl animate-in zoom-in-95 duration-300">
                       <div className="p-4 border-b dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-gray-900/50 font-sans"><h3 className="font-bold dark:text-white font-sans">Opname QR Scanner</h3><button onClick={() => setIsScannerOpen(false)} className="text-gray-400 hover:text-red-600"><X size={20}/></button></div>
                       <div className="p-6 font-sans"><div className="relative w-full aspect-square overflow-hidden rounded-xl bg-black"><div id="opname-qr-reader" className="w-full h-full"></div><div className="absolute top-0 left-0 w-full h-1 bg-blue-500 animate-scan-line"></div></div></div>
                     </div>
                  </div>
               )}
            </div>
          );
        };

        // --- VIEW: FORM TRANSAKSI ---
        const TransactionFormView = ({ items, setItems, transactions, setTransactions, suppliers, showNotification, setCurrentView, fonnteToken, waGroupId }) => {
          const [trxType, setTrxType] = useState(''); 
          const isIn = trxType === 'IN';
          const [headerData, setHeaderData] = useState({ ref: '', notes: '' });
          const [cart, setCart] = useState([]);
          const [currentInput, setCurrentInput] = useState({ itemId: '', qty: '', binId: '' });
          const [selectedCategoryFilter, setSelectedCategoryFilter] = useState('');

          const uniqueCategories = useMemo(() => [...new Set(items.map(item => item.category))], [items]);
          const filteredItemsForDropdown = useMemo(() => !selectedCategoryFilter ? items : items.filter(item => item.category === selectedCategoryFilter), [items, selectedCategoryFilter]);
          
          const selectedItemInfo = items.find(i => i.id === currentInput.itemId);
          const qtyInCart = cart.filter(c => c.itemId === currentInput.itemId).reduce((sum, c) => sum + Number(c.qty), 0);
          const availableStock = selectedItemInfo ? selectedItemInfo.stock - (!isIn ? qtyInCart : 0) : 0;

          const [isScannerOpen, setIsScannerOpen] = useState(false);
          const [isScriptLoaded, setIsScriptLoaded] = useState(false);
          const scannerRef = useRef(null);
          const qtyRef = useRef(null);

          useEffect(() => {
            if(selectedItemInfo && isIn) {
              setCurrentInput(prev => ({...prev, binId: selectedItemInfo.location}));
            } else if (!isIn) {
              setCurrentInput(prev => ({...prev, binId: ''}));
            }
          }, [selectedItemInfo, isIn]);

          useEffect(() => {
            if (window.Html5Qrcode) { setIsScriptLoaded(true); return; }
            const script = document.createElement('script');
            script.src = "https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js";
            script.async = true;
            script.onload = () => setIsScriptLoaded(true);
            document.body.appendChild(script);
          }, []);

          const processScan = (scannedId) => {
            const found = items.find(i => i.id.toUpperCase() === scannedId.toUpperCase());
            if(found) {
              setCurrentInput(prev => ({...prev, itemId: found.id}));
              setIsScannerOpen(false);
              showNotification(`Item Terbaca: ${found.name}`);
              setTimeout(() => qtyRef.current?.focus(), 250);
            } else {
              showNotification(`Item "${scannedId}" tidak ditemukan!`, 'error');
            }
          };

          const safeStopScanner = () => { 
            if (scannerRef.current) { 
              try {
                if (scannerRef.current.getState() === 2) {
                  scannerRef.current.stop().catch(() => {});
                }
              } catch (error) {}
              scannerRef.current = null; 
            } 
          };

          useEffect(() => {
            let isMounted = true;
            if (isScannerOpen && isScriptLoaded) {
              setTimeout(() => {
                try {
                  const html5QrCode = new window.Html5Qrcode("trx-qr-reader");
                  scannerRef.current = html5QrCode;
                  html5QrCode.start({ facingMode: "environment" }, { fps: 12, qrbox: 250 }, (decodedText) => { if (isMounted) { safeStopScanner(); processScan(decodedText); } }, () => {}).catch(() => {});
                } catch (e) {}
              }, 400);
            }
            return () => { isMounted = false; safeStopScanner(); };
          }, [isScannerOpen, isScriptLoaded]);

          const handleAddToList = () => {
            if (!currentInput.itemId || !currentInput.qty) { showNotification('Lengkapi data barang!', 'error'); return; }
            const qtyNum = Number(currentInput.qty);
            if (qtyNum <= 0) return;
            const selectedItem = items.find(i => i.id === currentInput.itemId);
            if (!isIn && selectedItem.stock < (qtyNum + qtyInCart)) { showNotification('Stok tidak mencukupi!', 'error'); return; }
            const existsIdx = cart.findIndex(c => c.itemId === selectedItem.id);
            if (existsIdx > -1) {
              const newCart = [...cart]; newCart[existsIdx].qty = Number(newCart[existsIdx].qty) + qtyNum; setCart(newCart);
            } else {
              setCart([...cart, { cartId: Math.random(), itemId: selectedItem.id, name: selectedItem.name, qty: qtyNum, binId: selectedItem.location }]);
            }
            setCurrentInput({ itemId: '', qty: '', binId: '' });
          };

          const sendWaNotification = async (message) => {
            if (!fonnteToken || !waGroupId) return;
            
            try {
              const formData = new FormData();
              formData.append('target', waGroupId);
              formData.append('message', message);
              
              const response = await fetch("https://api.fonnte.com/send", {
                method: 'POST',
                headers: { 'Authorization': fonnteToken },
                body: formData
              });
              
              const result = await response.json();
              if (result.status) {
                 showNotification('Notifikasi WA Group berhasil dikirim!');
              } else {
                 console.error("Fonnte Error:", result);
                 showNotification('Gagal mengirim WA: Periksa token/target.', 'error');
              }
            } catch (error) {
              console.error("Gagal request Fonnte:", error);
              showNotification('Gagal terhubung ke API WA.', 'error');
            }
          };

          const handleSubmitBatch = () => {
            if (cart.length === 0) return;
            if (!headerData.ref.trim()) { showNotification('Isi referensi!', 'error'); return; }
            if (isIn && !headerData.notes) { showNotification('Pilih Supplier!', 'error'); return; }
            const now = new Date();
            const dateStr = `${now.toLocaleDateString('id-ID')} ${now.toLocaleTimeString('id-ID')}`;
            const newTrxs = cart.map((c, i) => ({ id: `TRX-${1000 + transactions.length + i + 1}`, date: dateStr, type: trxType, itemId: c.itemId, qty: c.qty, user: 'Administrator', ref: headerData.ref, dept: headerData.notes || '-' }));
            const updatedItems = items.map(item => {
              const trxQty = cart.filter(c => c.itemId === item.id).reduce((sum, c) => sum + Number(c.qty), 0);
              return trxQty > 0 ? { ...item, stock: isIn ? item.stock + trxQty : item.stock - trxQty } : item;
            });
            setItems(updatedItems); setTransactions([...newTrxs, ...transactions]);
            showNotification('Transaksi disimpan!');
            
            const tipeTransaksi = isIn ? 'BARANG MASUK (Goods Receipt)' : 'BARANG KELUAR (Goods Issue)';
            const refTeks = isIn ? 'Supplier/PO' : 'Requester';
            const detailBarang = cart.map((c, i) => ` ${i+1}. ${c.name} (${c.qty} ${items.find(x => x.id === c.itemId)?.unit || 'pcs'})`).join('\n');
            const waMessage = `*NOTIFIKASI TRANSAKSI SPMS*\n\n*Tipe*: ${tipeTransaksi}\n*Waktu*: ${dateStr}\n*${refTeks}*: ${isIn ? headerData.notes : headerData.ref}\n*User*: Administrator\n\n*Detail Material:*\n${detailBarang}\n\n_Pesan otomatis dari Sistem SPMS_`;
            
            sendWaNotification(waMessage);

            setTrxType(''); setCart([]); setCurrentView('dashboard');
          };

          if (!trxType) {
            return (
              <div className="max-w-4xl mx-auto space-y-6 text-center mt-6 animate-in zoom-in-95 duration-500 font-sans">
                <h2 className="text-3xl font-bold dark:text-white uppercase mb-8 font-sans">Pilih Tipe Transaksi</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 pt-4 font-sans">
                  <button onClick={() => setTrxType('IN')} className="p-12 bg-white dark:bg-gray-800 border-2 border-green-100 hover:border-green-500 rounded-2xl transition-all shadow-sm group font-sans">
                    <ArrowDownToLine size={48} className="mx-auto text-green-600 mb-6 group-hover:scale-110 transition-transform" />
                    <h3 className="text-xl font-bold dark:text-white uppercase font-sans">Goods Receipt (IN)</h3>
                    <p className="text-gray-400 text-sm mt-2 font-sans italic">Penerimaan Barang Baru</p>
                  </button>
                  <button onClick={() => setTrxType('OUT')} className="p-12 bg-white dark:bg-gray-800 border-2 border-orange-100 hover:border-orange-500 rounded-2xl transition-all shadow-sm group font-sans">
                    <ArrowUpFromLine size={48} className="mx-auto text-orange-600 mb-6 group-hover:scale-110 transition-transform" />
                    <h3 className="text-xl font-bold dark:text-white uppercase font-sans">Goods Issue (OUT)</h3>
                    <p className="text-gray-400 text-sm mt-2 font-sans italic">Pengeluaran Pemakaian</p>
                  </button>
                </div>
              </div>
            );
          }

          return (
            <div className="max-w-4xl mx-auto space-y-6 animate-in fade-in duration-300 pb-12 font-sans">
              <div className="flex items-center gap-4 font-sans">
                <button onClick={() => { if(cart.length > 0 && !window.confirm('Reset data?')) return; setTrxType(''); }} className="p-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-800 rounded-xl hover:bg-gray-50 shadow-sm font-sans"><ArrowRightLeft size={20} className="text-blue-600"/></button>
                <div className="font-sans"><h2 className="text-2xl font-bold dark:text-white flex items-center gap-3 tracking-tight font-sans">{isIn ? 'Goods Receipt' : 'Goods Issue'}</h2><p className="text-gray-400 text-xs font-sans uppercase tracking-widest">{isIn ? 'Barang Masuk' : 'Barang Keluar'}</p></div>
              </div>

              <div className="bg-white dark:bg-gray-800 rounded-xl border dark:border-gray-700 shadow-sm p-6 space-y-4 font-sans">
                {isIn && <h3 className="text-lg font-bold dark:text-white border-b dark:border-gray-700 pb-3 mb-2 font-sans">1. Informasi Dokumen</h3>}
                <div className={`grid grid-cols-1 ${isIn ? 'md:grid-cols-2' : ''} gap-5 font-sans`}>
                  <div>
                    <label className="block text-sm font-medium dark:text-gray-300 mb-1 font-sans">{isIn ? 'No. SJ atau PO *' : 'Nama Requester *'}</label>
                    <input type="text" className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg dark:bg-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 font-sans" placeholder={isIn ? 'SJ-001' : 'Nama Pengambil'} value={headerData.ref} onChange={e => setHeaderData({...headerData, ref: e.target.value})} />
                  </div>
                  {isIn && (
                    <div>
                      <label className="block text-sm font-medium dark:text-gray-300 mb-1 font-sans">Supplier *</label>
                      <select className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg dark:bg-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 font-sans" value={headerData.notes} onChange={e => setHeaderData({...headerData, notes: e.target.value})}>
                        <option value="">-- Pilih Supplier --</option>
                        {suppliers.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                      </select>
                    </div>
                  )}
                </div>
              </div>

              <div className="bg-white dark:bg-gray-800 rounded-xl border dark:border-gray-700 shadow-sm p-6 font-sans">
                <h3 className="text-lg font-bold dark:text-white border-b dark:border-gray-700 pb-3 mb-4 uppercase tracking-wider text-xs font-sans">{isIn ? '2. Tambah Barang' : 'Tambah Barang'}</h3>
                <div className="flex flex-col md:flex-row gap-4 items-end font-sans">
                  <div className="flex-1 w-full space-y-4 font-sans">
                     <div className="grid grid-cols-1 md:grid-cols-2 gap-4 font-sans">
                       <div>
                          <label className="block text-xs font-bold text-gray-400 mb-1 uppercase font-sans">Kategori</label>
                          <select className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg dark:bg-gray-900 dark:text-white font-sans outline-none" value={selectedCategoryFilter} onChange={e => { setSelectedCategoryFilter(e.target.value); setCurrentInput({...currentInput, itemId: ''}); }}><option value="">Semua</option>{uniqueCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}</select>
                       </div>
                       <div>
                          <label className="block text-xs font-bold text-gray-400 mb-1 uppercase font-sans">Lokasi BIN</label>
                          <input type="text" className="w-full p-2.5 bg-gray-50 dark:bg-gray-900 border dark:border-gray-700 rounded-lg text-gray-500 cursor-not-allowed font-sans" value={selectedItemInfo?.location || '---'} disabled />
                       </div>
                     </div>
                     <div>
                        <label className="block text-xs font-bold text-gray-400 mb-1 uppercase font-sans">Pilih Material *</label>
                        <div className="flex gap-2 font-sans">
                          <select className="flex-1 p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg dark:bg-gray-900 dark:text-white font-sans outline-none focus:border-blue-500" value={currentInput.itemId} onChange={e => setCurrentInput({...currentInput, itemId: e.target.value})}>
                            <option value="">-- Pilih --</option>
                            {filteredItemsForDropdown.map(item => <option key={item.id} value={item.id}>{item.id} - {item.name}</option>)}
                          </select>
                          <button onClick={() => setIsScannerOpen(true)} className="p-2 border dark:border-gray-600 rounded-lg hover:bg-gray-100 font-sans transition-colors"><QrCode size={20}/></button>
                        </div>
                        {selectedItemInfo && !isIn && <p className="text-xs font-bold text-blue-600 mt-1 font-sans italic"><Package size={14} className="inline"/> Stok Tersedia: {availableStock} {selectedItemInfo.unit}</p>}
                     </div>
                  </div>
                  <div className="w-full md:w-32 font-sans">
                    <label className="block text-sm font-medium dark:text-gray-300 mb-1 font-sans">Qty</label>
                    <input ref={qtyRef} type="number" min="1" className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg dark:bg-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 font-sans font-bold" value={currentInput.qty} onChange={e => setCurrentInput({...currentInput, qty: e.target.value})} onKeyDown={e => e.key === 'Enter' && (e.preventDefault(), handleAddToList())} />
                  </div>
                  <Button onClick={handleAddToList} icon={Plus} className="mt-4 md:mt-0 !py-2.5 font-sans uppercase font-bold text-xs tracking-wider">Tambah</Button>
                </div>
              </div>

              <div className="bg-white dark:bg-gray-800 rounded-xl border dark:border-gray-700 shadow-sm overflow-hidden font-sans">
                <div className="p-4 border-b dark:border-gray-700 bg-gray-50/50 dark:bg-gray-900/50 flex justify-between items-center font-sans"><h3 className="font-bold dark:text-white flex items-center gap-2 uppercase text-xs font-sans"><ShoppingCart size={18} className="text-blue-600"/> Daftar Item ({cart.length})</h3></div>
                <div className="overflow-x-auto min-h-[120px] font-sans">
                  {cart.length === 0 ? <div className="flex flex-col items-center py-12 opacity-30 text-gray-400 font-sans"><Package size={48}/><p className="mt-2 text-xs font-bold uppercase tracking-widest font-sans">Belum ada barang.</p></div> : 
                  <table className="w-full text-sm text-left font-sans">
                    <thead className="bg-gray-100 dark:bg-gray-750 dark:text-gray-300 text-xs uppercase font-sans font-bold">
                      <tr><th className="px-6 py-4 font-sans">No</th><th className="px-6 py-4 font-sans">Item Material</th>{isIn && <th className="px-6 py-4 text-center font-sans">BIN</th>}<th className="px-6 py-4 text-center font-sans">Qty</th><th className="px-6 py-4 text-center font-sans">Aksi</th></tr>
                    </thead>
                    <tbody className="divide-y dark:divide-gray-700 font-sans">
                      {cart.map((c, i) => (
                        <tr key={c.cartId} className="dark:text-white hover:bg-gray-50/50 transition-colors font-sans">
                          <td className="px-6 py-4 text-xs font-bold font-sans">{i+1}</td>
                          <td className="px-6 py-4 font-bold font-sans">{c.name}</td>
                          {isIn && <td className="px-6 py-4 text-center text-xs font-mono font-bold text-gray-500 font-sans">{c.binId}</td>}
                          <td className="px-6 py-4 text-center font-bold text-blue-600 font-sans">{c.qty}</td>
                          <td className="px-6 py-4 text-center font-sans"><button onClick={() => setCart(cart.filter(x => x.cartId !== c.cartId))} className="p-1.5 bg-red-50 text-red-500 rounded-lg hover:bg-red-100 transition-colors font-sans"><Trash2 size={16}/></button></td>
                        </tr>
                      ))}
                    </tbody>
                  </table>}
                </div>
                <div className="p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-900/30 flex justify-end gap-3 font-sans">
                  <Button variant="outline" onClick={() => { if(window.confirm('Reset input?')) { setCart([]); setTrxType(''); } }} className="font-sans font-bold text-xs uppercase">Batalkan</Button>
                  <Button onClick={handleSubmitBatch} icon={CheckCircle2} className={`${isIn ? '!bg-green-600 hover:bg-green-700' : '!bg-orange-600 hover:bg-orange-700'} font-sans font-bold text-xs uppercase`}>Simpan Transaksi</Button>
                </div>
              </div>
              {isScannerOpen && (
                <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
                  <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md overflow-hidden shadow-2xl animate-in zoom-in-95 duration-200">
                    <div className="p-4 border-b dark:border-gray-800 flex justify-between items-center font-sans bg-gray-50 dark:bg-gray-900/50"><div className="flex items-center gap-2"><QrCode className="text-blue-600" size={20} /><h3 className="font-bold dark:text-white font-sans">Scan QR</h3></div><button onClick={() => setIsScannerOpen(false)} className="text-gray-500 hover:text-red-600 transition-colors font-sans"><X size={24}/></button></div>
                    <div className="p-6 font-sans"><div className="relative w-full aspect-square overflow-hidden rounded-xl bg-black"><div id="trx-qr-reader" className="w-full h-full"></div><div className="absolute top-0 left-0 w-full h-1 bg-blue-500 animate-scan-line shadow-[0_0_15px_blue]"></div></div><p className="text-center text-xs text-gray-500 mt-4 font-sans italic">Posisikan kode di tengah kotak.</p></div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        // --- VIEW: SETTINGS ---
        const SettingsView = ({ adminPassword, setAdminPassword, showNotification, fonnteToken, setFonnteToken, waGroupId, setWaGroupId }) => {
          const [oldPassword, setOldPassword] = useState('');
          const [newPassword, setNewPassword] = useState('');
          const [confirmPassword, setConfirmPassword] = useState('');

          const [showOld, setShowOld] = useState(false);
          const [showNew, setShowNew] = useState(false);
          const [showConfirm, setShowConfirm] = useState(false);

          const [localToken, setLocalToken] = useState(fonnteToken);
          const [localTarget, setLocalTarget] = useState(waGroupId);

          const handleSavePassword = (e) => {
            e.preventDefault();
            if (oldPassword !== adminPassword) {
              showNotification('Gagal: Password lama yang Anda masukkan salah!', 'error');
              return;
            }
            if (newPassword !== confirmPassword) {
              showNotification('Gagal: Konfirmasi password baru tidak cocok!', 'error');
              return;
            }
            if (newPassword.length < 4) {
              showNotification('Gagal: Password baru terlalu pendek (min 4 karakter).', 'error');
              return;
            }
            
            setAdminPassword(newPassword);
            setOldPassword(''); setNewPassword(''); setConfirmPassword('');
            showNotification('Berhasil! Password otoritas admin telah diubah.');
          };

          const handleSaveWaConfig = (e) => {
            e.preventDefault();
            setFonnteToken(localToken);
            setWaGroupId(localTarget);
            showNotification('Berhasil! Konfigurasi API Fonnte WhatsApp disimpan.');
          };

          return (
            <div className="space-y-6 animate-in fade-in duration-300 font-sans pb-10">
               <div className="flex justify-between items-end border-b dark:border-gray-800 pb-4">
                  <div>
                    <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Pengaturan Sistem</h2>
                    <p className="text-gray-500 dark:text-gray-400 mt-1">Konfigurasi keamanan dan preferensi aplikasi</p>
                  </div>
               </div>

               <div className="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                 <div className="bg-white dark:bg-gray-900 p-6 rounded-2xl border dark:border-gray-800 shadow-sm">
                   <h3 className="text-lg font-bold dark:text-white mb-1 flex items-center gap-2"><Settings size={18} className="text-blue-500"/> Otorisasi Data Master</h3>
                   <p className="text-xs text-gray-500 mb-6">Ubah password yang digunakan untuk menyetujui proses Edit & Hapus barang pada Master Material.</p>
                   
                   <form onSubmit={handleSavePassword} className="space-y-5">
                     <div>
                       <label className="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1.5">Password Admin Lama</label>
                       <div className="relative">
                         <input type={showOld ? "text" : "password"} placeholder="Masukkan password lama" required className="w-full p-2.5 pr-10 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-950 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" value={oldPassword} onChange={e => setOldPassword(e.target.value)} />
                         <button type="button" onClick={() => setShowOld(!showOld)} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">{showOld ? <EyeOff size={18} /> : <Eye size={18} />}</button>
                       </div>
                     </div>
                     <div className="pt-2">
                       <label className="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1.5">Password Admin Baru</label>
                       <div className="relative">
                         <input type={showNew ? "text" : "password"} placeholder="Masukkan password baru" required className="w-full p-2.5 pr-10 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-950 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" value={newPassword} onChange={e => setNewPassword(e.target.value)} />
                         <button type="button" onClick={() => setShowNew(!showNew)} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">{showNew ? <EyeOff size={18} /> : <Eye size={18} />}</button>
                       </div>
                     </div>
                     <div>
                       <label className="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1.5">Konfirmasi Password Baru</label>
                       <div className="relative">
                         <input type={showConfirm ? "text" : "password"} placeholder="Ketik ulang password baru" required className="w-full p-2.5 pr-10 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-950 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} />
                         <button type="button" onClick={() => setShowConfirm(!showConfirm)} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">{showConfirm ? <EyeOff size={18} /> : <Eye size={18} />}</button>
                       </div>
                     </div>
                     <div className="pt-4 border-t dark:border-gray-800 flex justify-end">
                       <Button type="submit" icon={Save}>Simpan Password</Button>
                     </div>
                   </form>
                 </div>

                 <div className="bg-white dark:bg-gray-900 p-6 rounded-2xl border dark:border-gray-800 shadow-sm">
                   <h3 className="text-lg font-bold dark:text-white mb-1 flex items-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-green-500"><path d="M3 21l1.65-3.8a9 9 0 1 1 3.4 2.9L3 21"/><path d="M9 10a.5.5 0 0 0 1 0V9a.5.5 0 0 0-1 0v1Z"/><path d="M14 10a.5.5 0 0 0 1 0V9a.5.5 0 0 0-1 0v1Z"/><path d="M9.5 13.5c1.5 1 3.5 1 5 0"/></svg>
                     Notifikasi WhatsApp (Fonnte)
                   </h3>
                   <p className="text-xs text-gray-500 mb-6">Pesan otomatis akan dikirim ke Group WA/Nomor tujuan setiap ada Barang Masuk atau Barang Keluar.</p>
                   
                   <form onSubmit={handleSaveWaConfig} className="space-y-5">
                     <div>
                       <label className="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1.5">Fonnte API Token</label>
                       <input 
                         type="text" 
                         placeholder="Contoh: xxxxxxxx-xxxx-xxxx..." 
                         className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-950 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" 
                         value={localToken} 
                         onChange={e => setLocalToken(e.target.value)} 
                       />
                     </div>
                     <div className="pt-2">
                       <label className="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1.5">Target / WA Group ID</label>
                       <input 
                         type="text" 
                         placeholder="Contoh: 120363041@g.us atau 0812..." 
                         className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-950 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" 
                         value={localTarget} 
                         onChange={e => setLocalTarget(e.target.value)} 
                       />
                       <p className="text-[10px] text-gray-400 mt-1 italic">Dapatkan Group ID dari API Fonnte atau masukkan nomor pribadi.</p>
                     </div>
                     
                     <div className="pt-4 border-t dark:border-gray-800 flex justify-end">
                       <Button type="submit" variant="primary" className="!bg-green-600 hover:!bg-green-700 focus:ring-green-500" icon={Save}>Simpan WA API</Button>
                     </div>
                   </form>
                 </div>
               </div>
            </div>
          );
        };

        // --- MAIN APPLICATION ---
        const App = () => {
          const [darkMode, setDarkMode] = useState(false);
          const [sidebarOpen, setSidebarOpen] = useState(false);
          const [isSidebarHovered, setIsSidebarHovered] = useState(false);
          const [currentView, setCurrentView] = useState('dashboard');
          const [openSections, setOpenSections] = useState({ master: true, transactions: true });

          const [adminPassword, setAdminPassword] = useState('admin123');
          const [fonnteToken, setFonnteToken] = useState('');
          const [waGroupId, setWaGroupId] = useState('');

          const [items, setItems] = useState(initialItems);
          const [transactions, setTransactions] = useState(initialTransactions);
          const [suppliers] = useState(initialSuppliers);
          const [users] = useState(initialUsers);
          const [warehouseLayout, setWarehouseLayout] = useState(initialWarehouse);
          const [notifications, setNotifications] = useState([]);

          const showNotification = (message, type = 'success') => {
            const id = Date.now();
            setNotifications(prev => [...prev, { id, message: message.toString(), type }]);
            setTimeout(() => setNotifications(prev => prev.filter(n => n.id !== id)), 4000);
          };

          useEffect(() => {
            if (darkMode) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
          }, [darkMode]);

          const toggleSection = (section) => { if (!isSidebarHovered) return; setOpenSections(prev => ({ ...prev, [section]: !prev[section] })); };

          const NavItem = ({ id, icon: Icon, label, colorClass = "text-gray-500" }) => (
            <button
              onClick={() => { setCurrentView(id); setSidebarOpen(false); }}
              className={`w-full flex items-center justify-start gap-3 px-4 py-2.5 rounded-lg text-sm transition-all relative group font-sans ${currentView === id ? 'bg-blue-600 text-white shadow-md font-bold' : 'text-gray-900 dark:text-gray-100 font-bold hover:bg-gray-100 dark:hover:bg-gray-800'}`}
            >
              <div className={`shrink-0 transition-transform group-hover:scale-110 font-sans ${currentView === id ? 'text-white' : colorClass}`}><Icon size={18} /></div>
              <span className={`transition-all duration-300 whitespace-nowrap overflow-hidden text-left ${isSidebarHovered ? 'w-40 opacity-100' : 'w-0 opacity-0'}`}>
                {label}
              </span>
              {!isSidebarHovered && (
                <div className="absolute left-full ml-4 px-2 py-1.5 bg-gray-900 text-white text-[10px] rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-[70] pointer-events-none shadow-xl border border-gray-700 font-sans font-bold uppercase tracking-wider">
                  {label}
                </div>
              )}
            </button>
          );

          const renderContent = () => {
            switch (currentView) {
              case 'dashboard': return <DashboardView items={items} transactions={transactions} setCurrentView={setCurrentView} />;
              case 'master-item': return <MasterItemView items={items} setItems={setItems} showNotification={showNotification} adminPassword={adminPassword} warehouseLayout={warehouseLayout} />;
              case 'virtual-warehouse': return <VirtualWarehouseView items={items} warehouseLayout={warehouseLayout} setWarehouseLayout={setWarehouseLayout} showNotification={showNotification} />;
              case 'master-supplier': return <MasterSupplierView suppliers={suppliers} />;
              case 'master-user': return <MasterUserView users={users} />;
              case 'transaction-form': return <TransactionFormView items={items} setItems={setItems} transactions={transactions} setTransactions={setTransactions} suppliers={suppliers} showNotification={showNotification} setCurrentView={setCurrentView} fonnteToken={fonnteToken} waGroupId={waGroupId} />;
              case 'transaction-log': return <TransactionLogView transactions={transactions} items={items} showNotification={showNotification} />;
              case 'stock-opname': return <StockOpnameView items={items} setItems={setItems} transactions={transactions} setTransactions={setTransactions} showNotification={showNotification} />;
              case 'settings': return <SettingsView adminPassword={adminPassword} setAdminPassword={setAdminPassword} showNotification={showNotification} fonnteToken={fonnteToken} setFonnteToken={setFonnteToken} waGroupId={waGroupId} setWaGroupId={setWaGroupId} />;
              default: return null;
            }
          };

          return (
            <div className={`min-h-screen flex flex-col transition-all duration-300 font-sans ${darkMode ? 'dark' : ''} bg-[radial-gradient(ellipse_at_top_left,_var(--tw-gradient-stops))] from-blue-50 via-white to-white dark:from-gray-800 dark:via-gray-950 dark:to-gray-950`}>
              
              {/* HEADER UTAMA */}
              <header className="bg-white/80 dark:bg-gray-900/80 border-b dark:border-gray-800 h-16 flex items-center justify-between px-8 fixed top-0 left-0 right-0 z-50 shadow-sm backdrop-blur-xl font-sans">
                <div className="flex items-center gap-4 font-sans">
                  <button className="lg:hidden p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl font-sans" onClick={() => setSidebarOpen(true)}><Menu size={24}/></button>
                  
                  {/* LOGO BARU MENGGUNAKAN GAMBAR */}
                  <div 
                    className="flex items-center gap-2 group cursor-pointer font-sans" 
                    onClick={() => setCurrentView('dashboard')}
                    title="Kembali ke Dashboard"
                  >
                    <img 
                      src="./Gemini_Generated_Image_wm4f7wm4f7wm4f7w.jpg" 
                      alt="SPMS Logo" 
                      className="h-10 md:h-12 w-auto object-contain group-hover:scale-105 transition-transform"
                      onError={(e) => {
                        e.target.onerror = null; 
                        // Jika gambar tidak ditemukan, sembunyikan tag img dan tampilkan teks pengganti
                        e.target.style.display = 'none';
                        const fallbackText = document.createElement('div');
                        fallbackText.className = "flex items-center gap-4 group cursor-default font-sans";
                        fallbackText.innerHTML = `
                          <div class="bg-blue-600 p-2.5 rounded-2xl text-white shadow-xl shadow-blue-500/20 font-sans group-hover:scale-105 transition-transform">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7.5 4.27 9 5.15"></path><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"></path><path d="m3.3 7 8.7 5 8.7-5"></path><path d="M12 22V12"></path></svg>
                          </div>
                          <div class="flex flex-col font-sans">
                            <span class="text-xl font-bold dark:text-white tracking-tight leading-none text-blue-600 font-sans">
                              SPMS
                            </span>
                            <span class="text-[10px] text-gray-400 font-medium leading-none mt-1 uppercase tracking-wider font-sans">
                              Spare part management system
                            </span>
                          </div>
                        `;
                        e.target.parentNode.appendChild(fallbackText);
                      }}
                    />
                  </div>
                </div>

                <div className="flex items-center gap-4 ml-auto font-sans">
                  <button onClick={() => setDarkMode(!darkMode)} className="p-2 bg-gray-50 dark:bg-gray-800 rounded-xl text-gray-500 transition-all hover:bg-blue-50 border border-gray-100 dark:border-gray-700 font-sans">
                    {darkMode ? <Sun size={18} className="text-amber-400 font-sans"/> : <Moon size={18} className="font-sans"/>}
                  </button>
                  <div className="flex items-center gap-3 group cursor-pointer pl-4 border-l dark:border-gray-800 font-sans">
                    <div className="flex flex-col items-end hidden sm:flex font-sans">
                      <span className="text-xs font-bold dark:text-white font-sans uppercase">Admin SPMS</span>
                      <div className="flex items-center gap-1 font-bold text-green-500 uppercase text-[9px] tracking-wider font-sans">Online</div>
                    </div>
                    <div className="w-9 h-9 rounded-xl bg-blue-600 flex items-center justify-center text-white font-bold shadow-md font-sans">A</div>
                  </div>
                </div>
              </header>

              <div className="flex flex-1 pt-16 font-sans">
                {/* SIDEBAR */}
                <aside 
                  onMouseEnter={() => setIsSidebarHovered(true)}
                  onMouseLeave={() => setIsSidebarHovered(false)}
                  className={`fixed top-16 left-0 bottom-0 z-40 bg-white dark:bg-gray-900 border-r dark:border-gray-800 transition-all duration-300 ease-in-out transform lg:translate-x-0 
                    ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} 
                    ${isSidebarHovered ? 'w-64 shadow-2xl' : 'w-16'}`}
                >
                  <div className="flex flex-col h-full overflow-hidden font-sans">
                    <div className="flex-1 overflow-y-auto py-8 px-2 space-y-6 font-sans">
                      <NavItem id="dashboard" icon={LayoutDashboard} label="Dashboard" colorClass="text-blue-500" />
                      
                      <div className="space-y-2 font-sans">
                        <button onClick={() => toggleSection('master')} className="w-full flex items-center justify-between px-3 py-1 text-xs font-black text-gray-900 dark:text-gray-100 uppercase tracking-widest hover:text-blue-600 transition-colors font-sans">
                          <span className={`transition-opacity duration-300 text-left ${isSidebarHovered ? 'opacity-100' : 'opacity-0'} font-sans`}>Master Data</span>
                          {isSidebarHovered && (openSections.master ? <ChevronDown size={14}/> : <ChevronRight size={14}/>)}
                        </button>
                        <div className={`space-y-1.5 transition-all duration-300 ${isSidebarHovered && openSections.master ? 'max-h-64 opacity-100' : 'max-h-0 opacity-0'} overflow-hidden font-sans`}>
                          <NavItem id="master-item" icon={Package} label="Material Items" colorClass="text-indigo-500" />
                          <NavItem id="virtual-warehouse" icon={MapIcon} label="Virtual Warehouse" colorClass="text-pink-500" />
                          <NavItem id="master-supplier" icon={Truck} label="Suppliers" colorClass="text-amber-500" />
                          <NavItem id="master-user" icon={Users} label="System Users" colorClass="text-rose-500" />
                        </div>
                      </div>

                      <div className="space-y-2 font-sans">
                        <button onClick={() => toggleSection('transactions')} className="w-full flex items-center justify-between px-3 py-1 text-xs font-black text-gray-900 dark:text-gray-100 uppercase tracking-widest hover:text-blue-600 transition-colors font-sans">
                          <span className={`transition-opacity duration-300 text-left ${isSidebarHovered ? 'opacity-100' : 'opacity-0'} font-sans`}>Transactions</span>
                          {isSidebarHovered && (openSections.transactions ? <ChevronDown size={14}/> : <ChevronRight size={14}/>)}
                        </button>
                        <div className={`space-y-1.5 transition-all duration-300 ${isSidebarHovered && openSections.transactions ? 'max-h-64 opacity-100' : 'max-h-0 opacity-0'} overflow-hidden font-sans`}>
                          <NavItem id="transaction-form" icon={Plus} label="Input Transaksi" colorClass="text-emerald-500" />
                          <NavItem id="transaction-log" icon={FileText} label="Laporan Transaksi" colorClass="text-cyan-500" />
                          <NavItem id="stock-opname" icon={RefreshCw} label="Stock Opname" colorClass="text-violet-500" />
                        </div>
                      </div>

                      {/* NAVIGASI MENU PENGATURAN */}
                      <div className="pt-4 mt-4 border-t border-gray-200 dark:border-gray-800">
                        <NavItem id="settings" icon={Settings} label="Pengaturan" colorClass="text-slate-500" />
                      </div>
                    </div>
                  </div>
                </aside>

                {/* AREA KONTEN UTAMA */}
                <main className={`flex-1 flex flex-col min-w-0 transition-all duration-300 ${isSidebarHovered ? 'lg:ml-64' : 'ml-16'} bg-transparent min-h-[calc(100vh-64px)] font-sans`}>
                  <div className="flex-1 p-4 lg:p-8 font-sans">
                    {renderContent()}
                  </div>
                  
                  {/* FOOTER COPYRIGHT */}
                  <footer className="py-5 px-8 border-t border-gray-200 dark:border-gray-800 bg-white/30 dark:bg-gray-900/30 text-center sm:text-left flex flex-col sm:flex-row justify-between items-center gap-2 font-sans mt-auto">
                    <p className="text-[10px] sm:text-xs font-bold text-gray-400 uppercase tracking-widest">
                      &copy; {new Date().getFullYear()} SPMS System
                    </p>
                    <p className="text-[10px] text-gray-400/80 font-medium">
                      Hak Cipta Dilindungi. Dibuat untuk manajemen spare part.
                    </p>
                  </footer>
                </main>
              </div>

              {/* NOTIFIKASI */}
              <div className="fixed bottom-6 right-6 z-[110] flex flex-col gap-3 pointer-events-none uppercase font-sans">
                {notifications.map(n => (
                  <div key={n.id} className={`pointer-events-auto px-5 py-3.5 rounded-xl shadow-2xl flex items-center gap-4 text-white animate-in slide-in-from-right-10 duration-300 ${n.type === 'error' ? 'bg-red-600' : 'bg-gray-900 dark:bg-blue-600'}`}>
                    {n.type === 'error' ? <AlertTriangle size={20} className="shrink-0 font-sans"/> : <CheckCircle2 size={20} className="text-white shrink-0 font-sans"/>}
                    <div className="text-xs font-bold leading-tight uppercase font-sans">{n.message}</div>
                  </div>
                ))}
              </div>
            </div>
          );
        };

        // Render aplikasi ke DOM
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
